<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#1e40af">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="í˜ˆì••">
  <title>í˜ˆì•• ê¸°ë¡ê¸°</title>
  <link rel="manifest" href="manifest.json">
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --blue: #1e40af;
      --blue-light: #3b82f6;
      --green: #16a34a;
      --yellow: #d97706;
      --orange: #ea580c;
      --red: #dc2626;
      --gray-50: #f8fafc;
      --gray-100: #f1f5f9;
      --gray-200: #e2e8f0;
      --gray-400: #94a3b8;
      --gray-600: #475569;
      --gray-800: #1e293b;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: var(--gray-50);
      color: var(--gray-800);
      min-height: 100vh;
      max-width: 480px;
      margin: 0 auto;
    }

    /* â”€â”€ í—¤ë” â”€â”€ */
    header {
      background: var(--blue);
      color: white;
      padding: 16px 20px 12px;
      position: sticky;
      top: 0;
      z-index: 100;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    header h1 { font-size: 1.1rem; font-weight: 600; }
    .header-actions { display: flex; gap: 8px; }
    .icon-btn {
      background: rgba(255,255,255,0.15);
      border: none;
      color: white;
      width: 36px; height: 36px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1rem;
      display: flex; align-items: center; justify-content: center;
    }
    .icon-btn:active { background: rgba(255,255,255,0.3); }

    /* â”€â”€ ë™ê¸°í™” ìƒíƒœ ë°” â”€â”€ */
    #sync-bar {
      background: #fef3c7;
      color: #92400e;
      font-size: 0.78rem;
      padding: 6px 20px;
      display: none;
      align-items: center;
      gap: 6px;
    }
    #sync-bar.show { display: flex; }
    #sync-bar.synced { background: #d1fae5; color: #065f46; }
    #sync-bar.error { background: #fee2e2; color: #991b1b; }

    /* â”€â”€ ì…ë ¥ ì¹´ë“œ â”€â”€ */
    .card {
      background: white;
      border-radius: 16px;
      margin: 16px;
      padding: 20px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.08);
    }
    .card-title {
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--gray-400);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 16px;
    }

    /* â”€â”€ BP ì…ë ¥ â”€â”€ */
    .bp-inputs {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 12px;
    }
    .input-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .input-group label {
      font-size: 0.78rem;
      font-weight: 600;
      color: var(--gray-600);
    }
    .input-group input {
      border: 2px solid var(--gray-200);
      border-radius: 12px;
      padding: 14px 12px;
      font-size: 1.6rem;
      font-weight: 700;
      color: var(--gray-800);
      text-align: center;
      width: 100%;
      outline: none;
      transition: border-color 0.15s;
      -webkit-appearance: none;
    }
    .input-group input:focus { border-color: var(--blue-light); }
    .input-group input::placeholder { color: var(--gray-200); font-weight: 400; font-size: 1.2rem; }

    .input-unit {
      font-size: 0.72rem;
      color: var(--gray-400);
      text-align: center;
    }

    .row-inputs {
      display: grid;
      grid-template-columns: 1fr 2fr;
      gap: 12px;
      margin-bottom: 12px;
    }
    .input-group input.small {
      font-size: 1.2rem;
      padding: 12px 10px;
    }
    .input-group input.note {
      font-size: 0.95rem;
      text-align: left;
      padding: 12px 14px;
    }

    /* â”€â”€ ë‚ ì§œ/ì‹œê°„ â”€â”€ */
    .datetime-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }
    #datetime-display {
      font-size: 0.9rem;
      color: var(--gray-600);
    }
    .text-btn {
      background: none;
      border: none;
      color: var(--blue-light);
      font-size: 0.82rem;
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 6px;
    }
    .text-btn:active { background: var(--gray-100); }

    /* â”€â”€ BP ë¶„ë¥˜ ë±ƒì§€ â”€â”€ */
    #bp-badge {
      display: none;
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 0.82rem;
      font-weight: 600;
      text-align: center;
      margin-bottom: 14px;
    }

    /* â”€â”€ ì €ì¥ ë²„íŠ¼ â”€â”€ */
    #save-btn {
      width: 100%;
      background: var(--blue);
      color: white;
      border: none;
      border-radius: 14px;
      padding: 16px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.15s, transform 0.1s;
    }
    #save-btn:active { background: #1e3a8a; transform: scale(0.98); }
    #save-btn:disabled { background: var(--gray-200); color: var(--gray-400); cursor: not-allowed; transform: none; }

    /* â”€â”€ ìµœê·¼ ê¸°ë¡ â”€â”€ */
    #records-list { display: flex; flex-direction: column; gap: 10px; }
    .record-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 16px;
      background: white;
      border-radius: 14px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.06);
      position: relative;
      overflow: hidden;
    }
    .record-accent {
      position: absolute;
      left: 0; top: 0; bottom: 0;
      width: 4px;
    }
    .record-left { padding-left: 8px; }
    .record-bp {
      font-size: 1.3rem;
      font-weight: 700;
      color: var(--gray-800);
    }
    .record-bp span { font-size: 0.85rem; font-weight: 400; color: var(--gray-400); }
    .record-meta {
      font-size: 0.78rem;
      color: var(--gray-400);
      margin-top: 2px;
    }
    .record-right { text-align: right; }
    .record-badge {
      font-size: 0.72rem;
      font-weight: 600;
      padding: 3px 8px;
      border-radius: 10px;
    }
    .record-pulse {
      font-size: 0.78rem;
      color: var(--gray-400);
      margin-top: 3px;
    }
    .delete-btn {
      background: none;
      border: none;
      color: var(--gray-400);
      font-size: 0.9rem;
      cursor: pointer;
      padding: 4px 6px;
      border-radius: 6px;
      margin-left: 8px;
    }
    .delete-btn:active { color: var(--red); background: #fee2e2; }

    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: var(--gray-400);
    }
    .empty-state .icon { font-size: 2.5rem; margin-bottom: 8px; }

    /* â”€â”€ í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ â”€â”€ */
    .bottom-nav {
      position: fixed;
      bottom: 0; left: 50%;
      transform: translateX(-50%);
      width: 100%;
      max-width: 480px;
      background: white;
      border-top: 1px solid var(--gray-200);
      display: flex;
    }
    .nav-btn {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 10px 8px;
      background: none;
      border: none;
      cursor: pointer;
      color: var(--gray-400);
      font-size: 0.7rem;
      gap: 2px;
      text-decoration: none;
    }
    .nav-btn.active { color: var(--blue); }
    .nav-btn .nav-icon { font-size: 1.3rem; }

    /* â”€â”€ ì„¤ì • í™”ë©´ â”€â”€ */
    #settings-screen {
      display: none;
      position: fixed;
      inset: 0;
      background: var(--gray-50);
      z-index: 200;
      overflow-y: auto;
    }
    .settings-header {
      background: var(--blue);
      color: white;
      padding: 16px 20px;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .settings-header h2 { font-size: 1.1rem; font-weight: 600; }
    .settings-body { padding: 20px; }
    .settings-label {
      font-size: 0.82rem;
      font-weight: 600;
      color: var(--gray-600);
      margin-bottom: 6px;
      display: block;
    }
    .settings-input {
      width: 100%;
      border: 2px solid var(--gray-200);
      border-radius: 10px;
      padding: 12px 14px;
      font-size: 0.9rem;
      outline: none;
      color: var(--gray-800);
    }
    .settings-input:focus { border-color: var(--blue-light); }
    .settings-hint {
      font-size: 0.78rem;
      color: var(--gray-400);
      margin-top: 6px;
      line-height: 1.4;
    }
    .settings-save-btn {
      width: 100%;
      background: var(--blue);
      color: white;
      border: none;
      border-radius: 12px;
      padding: 14px;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      margin-top: 20px;
    }
    .settings-save-btn:active { background: #1e3a8a; }
    .setup-banner {
      background: #eff6ff;
      border: 1px solid #bfdbfe;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 20px;
    }
    .setup-banner p { font-size: 0.85rem; color: #1e40af; line-height: 1.5; }
    .setup-banner strong { font-weight: 600; }

    /* â”€â”€ í† ìŠ¤íŠ¸ â”€â”€ */
    #toast {
      position: fixed;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%) translateY(20px);
      background: var(--gray-800);
      color: white;
      padding: 10px 20px;
      border-radius: 20px;
      font-size: 0.88rem;
      opacity: 0;
      transition: opacity 0.2s, transform 0.2s;
      pointer-events: none;
      white-space: nowrap;
      z-index: 300;
    }
    #toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

    /* í•˜ë‹¨ ì—¬ë°± (nav ë†’ì´) */
    .bottom-pad { height: 70px; }
  </style>
</head>
<body>

<header>
  <h1>â¤ï¸ í˜ˆì•• ê¸°ë¡ê¸°</h1>
  <div class="header-actions">
    <button class="icon-btn" onclick="openSettings()" title="ì„¤ì •">âš™ï¸</button>
  </div>
</header>

<div id="sync-bar"></div>

<!-- ì…ë ¥ ì¹´ë“œ -->
<div class="card">
  <div class="card-title">í˜ˆì•• ì¸¡ì •ê°’ ì…ë ¥</div>

  <div class="bp-inputs">
    <div class="input-group">
      <label>ìˆ˜ì¶•ê¸° (SBP)</label>
      <input type="number" id="sbp" inputmode="numeric" placeholder="120" min="60" max="250" oninput="onBpInput()">
      <div class="input-unit">mmHg</div>
    </div>
    <div class="input-group">
      <label>ì´ì™„ê¸° (DBP)</label>
      <input type="number" id="dbp" inputmode="numeric" placeholder="80" min="40" max="150" oninput="onBpInput()">
      <div class="input-unit">mmHg</div>
    </div>
  </div>

  <div class="row-inputs">
    <div class="input-group">
      <label>ë§¥ë°• (ì„ íƒ)</label>
      <input type="number" id="pulse" inputmode="numeric" placeholder="72" class="small" min="30" max="220">
      <div class="input-unit">bpm</div>
    </div>
    <div class="input-group">
      <label>ë©”ëª¨ (ì„ íƒ)</label>
      <input type="text" id="notes" placeholder="ìš´ë™ ì „, ì•„ì¹¨..." class="note">
    </div>
  </div>

  <div class="datetime-row">
    <span id="datetime-display"></span>
    <button class="text-btn" onclick="setNow()">ì§€ê¸ˆìœ¼ë¡œ</button>
  </div>

  <div id="bp-badge"></div>

  <button id="save-btn" onclick="saveRecord()">ì €ì¥í•˜ê¸°</button>
</div>

<!-- ìµœê·¼ ê¸°ë¡ -->
<div class="card" style="padding-bottom: 12px;">
  <div class="card-title" style="display:flex; justify-content:space-between; align-items:center;">
    <span>ìµœê·¼ ê¸°ë¡</span>
    <a href="dashboard.html" style="color: var(--blue-light); font-size: 0.78rem; text-decoration: none;">ì „ì²´ ë³´ê¸° â†’</a>
  </div>
  <div id="records-list">
    <div class="empty-state">
      <div class="icon">ğŸ“‹</div>
      <div>ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</div>
    </div>
  </div>
</div>

<div class="bottom-pad"></div>

<!-- í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ -->
<nav class="bottom-nav">
  <button class="nav-btn active">
    <span class="nav-icon">â¤ï¸</span>
    <span>í˜ˆì••</span>
  </button>
  <a href="food.html" class="nav-btn">
    <span class="nav-icon">ğŸ¥—</span>
    <span>ì‹ì‚¬</span>
  </a>
  <a href="dashboard.html" class="nav-btn">
    <span class="nav-icon">ğŸ“Š</span>
    <span>ëŒ€ì‹œë³´ë“œ</span>
  </a>
</nav>

<!-- ì„¤ì • í™”ë©´ -->
<div id="settings-screen">
  <div class="settings-header">
    <button class="icon-btn" onclick="closeSettings()">â†</button>
    <h2>ì„¤ì •</h2>
  </div>
  <div class="settings-body">
    <div class="setup-banner">
      <p>
        <strong>ì²« ì„¤ì • ì•ˆë‚´</strong><br>
        Google Sheetsì—ì„œ Apps Scriptë¥¼ ë°°í¬í•œ ë’¤,
        ë°œê¸‰ëœ ì›¹ ì•± URLì„ ì•„ë˜ì— ì…ë ¥í•˜ì„¸ìš”.<br>
        ìì„¸í•œ ë°©ë²•ì€ README.mdë¥¼ ì°¸ê³ í•˜ì„¸ìš”.
      </p>
    </div>
    <label class="settings-label">Apps Script ì›¹ ì•± URL</label>
    <input type="url" id="api-url-input" class="settings-input"
      placeholder="https://script.google.com/macros/s/...">
    <div class="settings-hint">
      Google Apps Script ë°°í¬ í›„ ë°›ëŠ” URLì…ë‹ˆë‹¤.<br>
      ì´ URLì„ í†µí•´ Google Sheetsì— ë°ì´í„°ê°€ ì €ì¥ë©ë‹ˆë‹¤.
    </div>
    <button class="settings-save-btn" onclick="saveSettings()">ì €ì¥</button>
  </div>
</div>

<!-- í† ìŠ¤íŠ¸ -->
<div id="toast"></div>

<script>
// â”€â”€ ìƒìˆ˜ â”€â”€
const STORAGE_KEY = 'bp_records';
const API_URL_KEY = 'bp_api_url';
const PENDING_KEY = 'bp_pending';

// â”€â”€ í˜ˆì•• ë¶„ë¥˜ â”€â”€
function classifyBP(sbp, dbp) {
  if (sbp > 180 || dbp > 120) return { label: 'ê³ í˜ˆì•• ìœ„ê¸°', color: '#7f1d1d', bg: '#fee2e2', accent: '#dc2626' };
  if (sbp >= 140 || dbp >= 90)  return { label: 'ê³ í˜ˆì•• 2ë‹¨ê³„', color: '#991b1b', bg: '#fee2e2', accent: '#ef4444' };
  if (sbp >= 130 || dbp >= 80)  return { label: 'ê³ í˜ˆì•• 1ë‹¨ê³„', color: '#9a3412', bg: '#ffedd5', accent: '#f97316' };
  if (sbp >= 120 && dbp < 80)   return { label: 'ì£¼ì˜í˜ˆì••', color: '#92400e', bg: '#fef3c7', accent: '#f59e0b' };
  return { label: 'ì •ìƒ', color: '#065f46', bg: '#d1fae5', accent: '#10b981' };
}

// â”€â”€ ë‚ ì§œ í¬ë§· â”€â”€
function formatDatetime(isoStr) {
  const d = new Date(isoStr);
  const pad = n => String(n).padStart(2, '0');
  const month = pad(d.getMonth() + 1);
  const day = pad(d.getDate());
  const hour = pad(d.getHours());
  const min = pad(d.getMinutes());
  return `${month}/${day} ${hour}:${min}`;
}

function formatDatetimeDisplay(isoStr) {
  const d = new Date(isoStr);
  return d.toLocaleString('ko-KR', {
    month: 'numeric', day: 'numeric',
    hour: '2-digit', minute: '2-digit',
    hour12: false
  });
}

// â”€â”€ í˜„ì¬ ë‚ ì§œ â”€â”€
let currentDatetime = new Date().toISOString();

function setNow() {
  currentDatetime = new Date().toISOString();
  document.getElementById('datetime-display').textContent = formatDatetimeDisplay(currentDatetime);
}

// â”€â”€ BP ì…ë ¥ ì‹œ ë¶„ë¥˜ í‘œì‹œ â”€â”€
function onBpInput() {
  const sbp = parseInt(document.getElementById('sbp').value);
  const dbp = parseInt(document.getElementById('dbp').value);
  const badge = document.getElementById('bp-badge');

  if (sbp >= 60 && dbp >= 40) {
    const cls = classifyBP(sbp, dbp);
    badge.style.display = 'block';
    badge.style.background = cls.bg;
    badge.style.color = cls.color;
    badge.textContent = cls.label;
  } else {
    badge.style.display = 'none';
  }
}

// â”€â”€ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ â”€â”€
function getRecords() {
  try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'); }
  catch { return []; }
}

function saveRecords(records) {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(records));
}

function getPending() {
  try { return JSON.parse(localStorage.getItem(PENDING_KEY) || '[]'); }
  catch { return []; }
}

function savePending(pending) {
  localStorage.setItem(PENDING_KEY, JSON.stringify(pending));
}

// â”€â”€ API í˜¸ì¶œ â”€â”€
async function syncToSheet(record) {
  const apiUrl = localStorage.getItem(API_URL_KEY);
  if (!apiUrl) return false;

  const params = new URLSearchParams({
    action: 'write',
    datetime: record.datetime,
    systolic: record.systolic,
    diastolic: record.diastolic,
    pulse: record.pulse || '',
    notes: record.notes || ''
  });

  try {
    const res = await fetch(`${apiUrl}?${params}`, { method: 'GET' });
    const data = await res.json();
    return data.ok === true;
  } catch {
    return false;
  }
}

async function deleteFromSheet(datetime) {
  const apiUrl = localStorage.getItem(API_URL_KEY);
  if (!apiUrl) return false;

  const params = new URLSearchParams({ action: 'delete', datetime });
  try {
    const res = await fetch(`${apiUrl}?${params}`, { method: 'GET' });
    const data = await res.json();
    return data.ok === true;
  } catch {
    return false;
  }
}

// â”€â”€ ë™ê¸°í™” ìƒíƒœ í‘œì‹œ â”€â”€
function showSyncBar(msg, type = '') {
  const bar = document.getElementById('sync-bar');
  bar.textContent = msg;
  bar.className = 'show' + (type ? ' ' + type : '');
  if (type === 'synced') {
    setTimeout(() => { bar.className = ''; }, 3000);
  }
}

// â”€â”€ ì €ì¥ â”€â”€
async function saveRecord() {
  const sbp = parseInt(document.getElementById('sbp').value);
  const dbp = parseInt(document.getElementById('dbp').value);
  const pulse = parseInt(document.getElementById('pulse').value) || null;
  const notes = document.getElementById('notes').value.trim();

  if (!sbp || sbp < 60 || sbp > 250) return showToast('ì˜¬ë°”ë¥¸ ìˆ˜ì¶•ê¸° ê°’ì„ ì…ë ¥í•˜ì„¸ìš” (60-250)');
  if (!dbp || dbp < 40 || dbp > 150) return showToast('ì˜¬ë°”ë¥¸ ì´ì™„ê¸° ê°’ì„ ì…ë ¥í•˜ì„¸ìš” (40-150)');

  const record = {
    datetime: currentDatetime,
    systolic: sbp,
    diastolic: dbp,
    pulse,
    notes,
    synced: false
  };

  // 1. ë¡œì»¬ ì €ì¥
  const records = getRecords();
  records.unshift(record);
  saveRecords(records);

  // 2. í¼ ì´ˆê¸°í™”
  document.getElementById('sbp').value = '';
  document.getElementById('dbp').value = '';
  document.getElementById('pulse').value = '';
  document.getElementById('notes').value = '';
  document.getElementById('bp-badge').style.display = 'none';
  setNow();
  renderRecords();
  showToast('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');

  // 3. ë™ê¸°í™” ì‹œë„
  const apiUrl = localStorage.getItem(API_URL_KEY);
  if (!apiUrl) {
    showSyncBar('âš ï¸ Apps Script URL ë¯¸ì„¤ì • â€” ì„¤ì •ì—ì„œ ì…ë ¥í•˜ì„¸ìš”');
    return;
  }

  showSyncBar('â˜ï¸ ë™ê¸°í™” ì¤‘...');
  const ok = await syncToSheet(record);
  if (ok) {
    records[0].synced = true;
    saveRecords(records);
    renderRecords();
    showSyncBar('âœ“ ë™ê¸°í™” ì™„ë£Œ', 'synced');
  } else {
    // ë³´ë¥˜ íì— ì¶”ê°€
    const pending = getPending();
    pending.push(record);
    savePending(pending);
    showSyncBar('âš ï¸ ë™ê¸°í™” ì‹¤íŒ¨ â€” ë‚˜ì¤‘ì— ì¬ì‹œë„ë©ë‹ˆë‹¤', 'error');
  }
}

// â”€â”€ ìˆ˜ë™ ë™ê¸°í™” â”€â”€
async function syncNow() {
  const pending = getPending();
  if (pending.length === 0) {
    showToast('ë™ê¸°í™”í•  í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤');
    return;
  }

  const apiUrl = localStorage.getItem(API_URL_KEY);
  if (!apiUrl) {
    openSettings();
    return;
  }

  showSyncBar(`â˜ï¸ ${pending.length}ê°œ í•­ëª© ë™ê¸°í™” ì¤‘...`);
  const failed = [];

  for (const record of pending) {
    const ok = await syncToSheet(record);
    if (!ok) failed.push(record);
  }

  savePending(failed);

  // ë¡œì»¬ ê¸°ë¡ì—ë„ synced ë§ˆí‚¹
  const records = getRecords();
  for (const r of records) {
    if (!r.synced && !failed.find(f => f.datetime === r.datetime)) {
      r.synced = true;
    }
  }
  saveRecords(records);
  renderRecords();

  if (failed.length === 0) {
    showSyncBar(`âœ“ ${pending.length}ê°œ ë™ê¸°í™” ì™„ë£Œ`, 'synced');
  } else {
    showSyncBar(`âš ï¸ ${failed.length}ê°œ ì‹¤íŒ¨, ${pending.length - failed.length}ê°œ ì™„ë£Œ`, 'error');
  }
}

// â”€â”€ ê¸°ë¡ ì‚­ì œ â”€â”€
async function deleteRecord(datetime) {
  if (!confirm('ì´ ê¸°ë¡ì„ ì‚­ì œí• ê¹Œìš”?')) return;

  const records = getRecords().filter(r => r.datetime !== datetime);
  saveRecords(records);
  renderRecords();
  showToast('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');

  // ì‹œíŠ¸ì—ì„œë„ ì‚­ì œ
  const apiUrl = localStorage.getItem(API_URL_KEY);
  if (apiUrl) {
    deleteFromSheet(datetime);
  }
}

// â”€â”€ ê¸°ë¡ ë Œë”ë§ â”€â”€
function renderRecords() {
  const records = getRecords().slice(0, 10); // ìµœê·¼ 10ê°œ
  const container = document.getElementById('records-list');

  if (records.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <div class="icon">ğŸ“‹</div>
        <div>ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</div>
      </div>`;
    return;
  }

  container.innerHTML = records.map(r => {
    const cls = classifyBP(r.systolic, r.diastolic);
    const syncIcon = r.synced ? 'â˜ï¸' : 'â³';
    const pulseInfo = r.pulse ? `â™¥ ${r.pulse} bpm` : '';
    const noteInfo = r.notes ? ` Â· ${r.notes}` : '';
    return `
      <div class="record-item">
        <div class="record-accent" style="background:${cls.accent}"></div>
        <div class="record-left">
          <div class="record-bp">${r.systolic}<span>/</span>${r.diastolic} <span>mmHg</span></div>
          <div class="record-meta">${formatDatetimeDisplay(r.datetime)}${noteInfo}</div>
        </div>
        <div class="record-right">
          <div class="record-badge" style="background:${cls.bg}; color:${cls.color}">${cls.label}</div>
          <div class="record-pulse">${pulseInfo} ${syncIcon}</div>
        </div>
        <button class="delete-btn" onclick="deleteRecord('${r.datetime}')" title="ì‚­ì œ">âœ•</button>
      </div>`;
  }).join('');
}

// â”€â”€ í† ìŠ¤íŠ¸ â”€â”€
function showToast(msg) {
  const toast = document.getElementById('toast');
  toast.textContent = msg;
  toast.classList.add('show');
  setTimeout(() => toast.classList.remove('show'), 2200);
}

// â”€â”€ ì„¤ì • â”€â”€
function openSettings() {
  const current = localStorage.getItem(API_URL_KEY) || '';
  document.getElementById('api-url-input').value = current;
  document.getElementById('settings-screen').style.display = 'block';
}

function closeSettings() {
  document.getElementById('settings-screen').style.display = 'none';
}

function saveSettings() {
  const url = document.getElementById('api-url-input').value.trim();
  if (url && !url.startsWith('https://script.google.com')) {
    showToast('ì˜¬ë°”ë¥¸ Apps Script URLì´ ì•„ë‹™ë‹ˆë‹¤');
    return;
  }
  localStorage.setItem(API_URL_KEY, url);
  closeSettings();
  showToast('ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');

  // URL ìƒˆë¡œ ì„¤ì •ë˜ë©´ pending ë™ê¸°í™” ì‹œë„
  if (url) syncNow();
}

// â”€â”€ ì´ˆê¸°í™” â”€â”€
function init() {
  setNow();
  renderRecords();

  // ì„¤ì • ì•ˆ ë˜ì–´ ìˆìœ¼ë©´ ì„¤ì • í™”ë©´ í‘œì‹œ
  const apiUrl = localStorage.getItem(API_URL_KEY);
  if (!apiUrl) {
    setTimeout(openSettings, 500);
  }

  // ë¯¸ë™ê¸°í™” í•­ëª© ìë™ ì¬ì‹œë„
  const pending = getPending();
  if (pending.length > 0 && apiUrl) {
    showSyncBar(`â³ ë¯¸ë™ê¸°í™” ${pending.length}ê°œ í•­ëª© ìˆìŒ â€” ë™ê¸°í™” íƒ­ì„ ëˆ„ë¥´ì„¸ìš”`);
  }

  // ì„œë¹„ìŠ¤ì›Œì»¤ ë“±ë¡
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./sw.js').catch(() => {});
  }
}

document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
