<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#6d28d9">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>ìš´ë™ ê¸°ë¡</title>
  <link rel="manifest" href="manifest.json">
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --purple: #6d28d9;
      --purple-light: #8b5cf6;
      --purple-bg: #ede9fe;
      --green: #059669;
      --green-bg: #d1fae5;
      --gray-50: #f8fafc; --gray-100: #f1f5f9; --gray-200: #e2e8f0;
      --gray-400: #94a3b8; --gray-600: #475569; --gray-800: #1e293b;
      --red: #dc2626;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: var(--gray-50); color: var(--gray-800);
      min-height: 100vh; max-width: 480px; margin: 0 auto;
    }

    /* â”€â”€ í—¤ë” â”€â”€ */
    header {
      background: var(--purple); color: white; padding: 16px 20px 12px;
      position: sticky; top: 0; z-index: 100;
      display: flex; align-items: center; justify-content: space-between;
    }
    header h1 { font-size: 1.1rem; font-weight: 600; }

    /* â”€â”€ ë™ê¸°í™” ìƒíƒœ ë°” â”€â”€ */
    #sync-bar {
      background: #fef3c7; color: #92400e; font-size: 0.78rem;
      padding: 6px 20px; display: none; align-items: center; gap: 6px;
    }
    #sync-bar.show { display: flex; }
    #sync-bar.synced { background: #d1fae5; color: #065f46; }
    #sync-bar.error { background: #fee2e2; color: #991b1b; }

    /* â”€â”€ ì¹´ë“œ â”€â”€ */
    .card {
      background: white; border-radius: 16px; margin: 16px; padding: 20px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.08);
    }
    .card-title {
      font-size: 0.8rem; font-weight: 600; color: var(--gray-400);
      text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 16px;
    }

    /* â”€â”€ ìš´ë™ ìœ í˜• í† ê¸€ â”€â”€ */
    .type-toggle { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 20px; }
    .type-btn {
      padding: 12px 8px; border: 2px solid var(--gray-200); border-radius: 12px;
      background: white; color: var(--gray-600); font-size: 0.88rem; font-weight: 600;
      cursor: pointer; text-align: center; transition: all 0.15s; line-height: 1.4;
    }
    .type-btn.active { border-color: var(--purple); background: var(--purple-bg); color: var(--purple); }
    .type-btn:active { transform: scale(0.97); }

    /* â”€â”€ í¼ â”€â”€ */
    .input-group { display: flex; flex-direction: column; gap: 4px; margin-bottom: 12px; }
    .input-group label { font-size: 0.78rem; font-weight: 600; color: var(--gray-600); }
    .input-group select,
    .input-group input {
      border: 2px solid var(--gray-200); border-radius: 12px;
      padding: 12px 14px; font-size: 1rem; color: var(--gray-800);
      width: 100%; outline: none; -webkit-appearance: none;
      transition: border-color 0.15s; background: white;
    }
    .input-group select:focus,
    .input-group input:focus { border-color: var(--purple-light); }
    .input-group input::placeholder { color: var(--gray-200); }
    .input-unit { font-size: 0.72rem; color: var(--gray-400); margin-top: 2px; }

    .row-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }

    /* â”€â”€ ë‚ ì§œ/ì‹œê°„ â”€â”€ */
    .datetime-row {
      display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;
    }
    #datetime-display { font-size: 0.9rem; color: var(--gray-600); }
    .text-btn {
      background: none; border: none; color: var(--purple-light);
      font-size: 0.82rem; cursor: pointer; padding: 4px 8px; border-radius: 6px;
    }
    .text-btn:active { background: var(--gray-100); }

    /* â”€â”€ ì €ì¥ ë²„íŠ¼ â”€â”€ */
    #save-btn {
      width: 100%; background: var(--purple); color: white; border: none;
      border-radius: 14px; padding: 16px; font-size: 1rem; font-weight: 600;
      cursor: pointer; transition: background 0.15s, transform 0.1s;
    }
    #save-btn:active { background: #5b21b6; transform: scale(0.98); }

    /* â”€â”€ ê¸°ë¡ ëª©ë¡ â”€â”€ */
    #records-list { display: flex; flex-direction: column; gap: 10px; }
    .record-item {
      display: flex; align-items: center; justify-content: space-between;
      padding: 14px 16px; background: white; border-radius: 14px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.06); position: relative; overflow: hidden;
    }
    .record-accent { position: absolute; left: 0; top: 0; bottom: 0; width: 4px; }
    .record-left { padding-left: 8px; flex: 1; min-width: 0; }
    .record-name { font-size: 1.1rem; font-weight: 700; color: var(--gray-800);
                   overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .record-meta { font-size: 0.78rem; color: var(--gray-400); margin-top: 2px; }
    .record-right { text-align: right; flex-shrink: 0; margin-left: 8px; }
    .record-badge { font-size: 0.72rem; font-weight: 600; padding: 3px 8px; border-radius: 10px; }
    .record-detail { font-size: 0.78rem; color: var(--gray-400); margin-top: 3px; }
    .delete-btn {
      background: none; border: none; color: var(--gray-400); font-size: 0.9rem;
      cursor: pointer; padding: 4px 6px; border-radius: 6px; margin-left: 8px; flex-shrink: 0;
    }
    .delete-btn:active { color: var(--red); background: #fee2e2; }

    .empty-state { text-align: center; padding: 40px 20px; color: var(--gray-400); }
    .empty-state .icon { font-size: 2.5rem; margin-bottom: 8px; }

    /* â”€â”€ í•˜ë‹¨ ë„¤ë¹„ â”€â”€ */
    .bottom-nav {
      position: fixed; bottom: 0; left: 50%; transform: translateX(-50%);
      width: 100%; max-width: 480px; background: white;
      border-top: 1px solid var(--gray-200); display: flex;
    }
    .nav-btn {
      flex: 1; display: flex; flex-direction: column; align-items: center;
      padding: 10px 4px; background: none; border: none; cursor: pointer;
      color: var(--gray-400); font-size: 0.65rem; gap: 2px; text-decoration: none;
    }
    .nav-btn.active { color: var(--purple); }
    .nav-icon { font-size: 1.25rem; }
    .bottom-pad { height: 70px; }

    /* â”€â”€ ë‚ ì§œ íƒìƒ‰ â”€â”€ */
    .date-nav { display: flex; align-items: center; justify-content: center;
                gap: 16px; padding: 12px 20px; background: white;
                border-bottom: 1px solid var(--gray-200); }
    .date-btn { background: none; border: none; font-size: 1.2rem; cursor: pointer;
                color: var(--gray-600); padding: 4px 8px; border-radius: 6px; }
    .date-btn:active { background: var(--gray-100); }
    #date-display { font-size: 0.95rem; font-weight: 600; color: var(--gray-800); }

    /* â”€â”€ í† ìŠ¤íŠ¸ â”€â”€ */
    #toast {
      position: fixed; bottom: 80px; left: 50%;
      transform: translateX(-50%) translateY(20px);
      background: var(--gray-800); color: white; padding: 10px 20px;
      border-radius: 20px; font-size: 0.88rem; opacity: 0;
      transition: opacity 0.2s, transform 0.2s; pointer-events: none;
      white-space: nowrap; z-index: 300;
    }
    #toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
  </style>
</head>
<body>

<header>
  <h1>ğŸ’ª ìš´ë™ ê¸°ë¡</h1>
</header>

<div id="sync-bar"></div>

<!-- ë‚ ì§œ ë„¤ë¹„ê²Œì´ì…˜ -->
<div class="date-nav">
  <button class="date-btn" onclick="changeDate(-1)">â€¹</button>
  <span id="date-display"></span>
  <button class="date-btn" onclick="changeDate(1)">â€º</button>
</div>

<!-- ì…ë ¥ ì¹´ë“œ -->
<div class="card">
  <div class="card-title">ìš´ë™ ê¸°ë¡ ì…ë ¥</div>

  <!-- ìš´ë™ ìœ í˜• í† ê¸€ -->
  <div class="type-toggle">
    <button class="type-btn active" id="btn-isometric" onclick="setType('isometric')">
      ğŸ§± ë“±ì²™ì„± ìš´ë™
    </button>
    <button class="type-btn" id="btn-cardio" onclick="setType('cardio')">
      ğŸƒ ìœ ì‚°ì†Œ ìš´ë™
    </button>
  </div>

  <!-- ë“±ì²™ì„± ìš´ë™ í¼ -->
  <div id="form-isometric">
    <div class="input-group">
      <label>ìš´ë™ ì„ íƒ</label>
      <select id="iso-name">
        <option value="í”Œë­í¬">í”Œë­í¬</option>
        <option value="ë²½ ìŠ¤ì¿¼íŠ¸">ë²½ ìŠ¤ì¿¼íŠ¸</option>
        <option value="í•¸ë“œê·¸ë¦½">í•¸ë“œê·¸ë¦½</option>
        <option value="ì‚¬ì´ë“œ í”Œë­í¬">ì‚¬ì´ë“œ í”Œë­í¬</option>
        <option value="ë³µê·¼ ìˆ˜ì¶•">ë³µê·¼ ìˆ˜ì¶•</option>
        <option value="ê¸°íƒ€">ê¸°íƒ€ (ì§ì ‘ ì…ë ¥)</option>
      </select>
    </div>
    <div id="iso-custom-wrap" class="input-group" style="display:none">
      <label>ìš´ë™ ì´ë¦„ ì§ì ‘ ì…ë ¥</label>
      <input type="text" id="iso-custom" placeholder="ìš´ë™ ì´ë¦„">
    </div>
    <div class="row-2">
      <div class="input-group">
        <label>ìœ ì§€ ì‹œê°„</label>
        <input type="number" id="iso-duration" inputmode="numeric" placeholder="30" min="1" max="3600">
        <div class="input-unit">ì´ˆ (seconds)</div>
      </div>
      <div class="input-group">
        <label>ì„¸íŠ¸ ìˆ˜</label>
        <input type="number" id="iso-sets" inputmode="numeric" placeholder="3" min="1" max="20">
        <div class="input-unit">ì„¸íŠ¸</div>
      </div>
    </div>
  </div>

  <!-- ìœ ì‚°ì†Œ ìš´ë™ í¼ -->
  <div id="form-cardio" style="display:none">
    <div class="input-group">
      <label>ìš´ë™ ì„ íƒ</label>
      <select id="cardio-name">
        <option value="ê±·ê¸°">ê±·ê¸°</option>
        <option value="ë‹¬ë¦¬ê¸°">ë‹¬ë¦¬ê¸°</option>
        <option value="ìì „ê±°">ìì „ê±°</option>
        <option value="ìˆ˜ì˜">ìˆ˜ì˜</option>
        <option value="ë“±ì‚°">ë“±ì‚°</option>
        <option value="ê¸°íƒ€">ê¸°íƒ€ (ì§ì ‘ ì…ë ¥)</option>
      </select>
    </div>
    <div id="cardio-custom-wrap" class="input-group" style="display:none">
      <label>ìš´ë™ ì´ë¦„ ì§ì ‘ ì…ë ¥</label>
      <input type="text" id="cardio-custom" placeholder="ìš´ë™ ì´ë¦„">
    </div>
    <div class="row-2">
      <div class="input-group">
        <label>ìš´ë™ ì‹œê°„</label>
        <input type="number" id="cardio-duration" inputmode="numeric" placeholder="30" min="1" max="600">
        <div class="input-unit">ë¶„ (minutes)</div>
      </div>
      <div class="input-group">
        <label>ê±°ë¦¬ (ì„ íƒ)</label>
        <input type="number" id="cardio-distance" inputmode="decimal" placeholder="3.5" min="0" step="0.1">
        <div class="input-unit">km</div>
      </div>
    </div>
  </div>

  <!-- ê³µí†µ -->
  <div class="input-group">
    <label>ë©”ëª¨ (ì„ íƒ)</label>
    <input type="text" id="notes" placeholder="ì˜¤ì „ ê³µì›, ì¸í„°ë²Œ íŠ¸ë ˆì´ë‹...">
  </div>

  <div class="datetime-row">
    <span id="datetime-display"></span>
    <button class="text-btn" onclick="setNow()">ì§€ê¸ˆìœ¼ë¡œ</button>
  </div>

  <button id="save-btn" onclick="saveRecord()">ì €ì¥í•˜ê¸°</button>
</div>

<!-- ìµœê·¼ ê¸°ë¡ -->
<div class="card" style="padding-bottom: 12px;">
  <div class="card-title">ë‹¹ì¼ ê¸°ë¡</div>
  <div id="records-list">
    <div class="empty-state">
      <div class="icon">ğŸ‹ï¸</div>
      <div>ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</div>
    </div>
  </div>
</div>

<div class="bottom-pad"></div>

<!-- í•˜ë‹¨ ë„¤ë¹„ -->
<nav class="bottom-nav">
  <a href="index.html" class="nav-btn"><span class="nav-icon">â¤ï¸</span><span>í˜ˆì••</span></a>
  <a href="food.html" class="nav-btn"><span class="nav-icon">ğŸ¥—</span><span>ì‹ì‚¬</span></a>
  <a href="meds.html" class="nav-btn"><span class="nav-icon">ğŸ’Š</span><span>ì•½</span></a>
  <button class="nav-btn active"><span class="nav-icon">ğŸ’ª</span><span>ìš´ë™</span></button>
  <a href="dashboard.html" class="nav-btn"><span class="nav-icon">ğŸ“Š</span><span>ëŒ€ì‹œë³´ë“œ</span></a>
</nav>

<!-- í† ìŠ¤íŠ¸ -->
<div id="toast"></div>

<script>
const API_URL_KEY = 'bp_api_url';

let currentType = 'isometric';
let currentDate = new Date();
let currentDatetime = new Date().toISOString();

// â”€â”€ ìš´ë™ ìœ í˜• ì „í™˜ â”€â”€
function setType(type) {
  currentType = type;
  document.getElementById('form-isometric').style.display = type === 'isometric' ? 'block' : 'none';
  document.getElementById('form-cardio').style.display = type === 'cardio' ? 'block' : 'none';
  document.getElementById('btn-isometric').classList.toggle('active', type === 'isometric');
  document.getElementById('btn-cardio').classList.toggle('active', type === 'cardio');
}

// â”€â”€ ê¸°íƒ€ ì„ íƒ ì‹œ ì§ì ‘ ì…ë ¥ í‘œì‹œ â”€â”€
function initSelectListeners() {
  document.getElementById('iso-name').addEventListener('change', function() {
    document.getElementById('iso-custom-wrap').style.display = this.value === 'ê¸°íƒ€' ? 'block' : 'none';
  });
  document.getElementById('cardio-name').addEventListener('change', function() {
    document.getElementById('cardio-custom-wrap').style.display = this.value === 'ê¸°íƒ€' ? 'block' : 'none';
  });
}

// â”€â”€ ë‚ ì§œ ìœ í‹¸ â”€â”€
function dateKey(d) {
  const y = d.getFullYear();
  const m = String(d.getMonth() + 1).padStart(2, '0');
  const day = String(d.getDate()).padStart(2, '0');
  return `${y}-${m}-${day}`;
}
function yesterday() { const d = new Date(); d.setDate(d.getDate() - 1); return dateKey(d); }
function displayDate(d) {
  const today = dateKey(new Date());
  const key   = dateKey(d);
  const label = key === today ? 'ì˜¤ëŠ˜' : key === yesterday() ? 'ì–´ì œ' : '';
  return d.toLocaleDateString('ko-KR', { month: 'long', day: 'numeric', weekday: 'short' })
         + (label ? ` (${label})` : '');
}
function changeDate(dir) {
  currentDate.setDate(currentDate.getDate() + dir);
  document.getElementById('date-display').textContent = displayDate(currentDate);
  setNow();
  renderRecords();
}
function getDateRecords() {
  const key = dateKey(currentDate);
  return allRecords.filter(r => r.datetime && r.datetime.startsWith(key));
}

// â”€â”€ ë‚ ì§œ/ì‹œê°„ â”€â”€
function setNow() {
  const now = new Date();
  currentDatetime = dateKey(currentDate) + 'T' + now.toTimeString().slice(0, 8);
  document.getElementById('datetime-display').textContent = formatDt(currentDatetime);
}

function formatDt(isoStr) {
  const d = new Date(isoStr);
  return d.toLocaleString('ko-KR', {
    month: 'numeric', day: 'numeric', hour: '2-digit', minute: '2-digit', hour12: false
  });
}

// â”€â”€ ë©”ëª¨ë¦¬ ìºì‹œ â”€â”€
let allRecords = [];
let writePending = false;

// â”€â”€ JSONP (CORS ìš°íšŒ) â”€â”€
function jsonpFetch(url, timeout = 12000) {
  return new Promise((resolve, reject) => {
    const cbName = '_gscb_' + Date.now();
    const timer = setTimeout(() => {
      delete window[cbName];
      if (script.parentNode) script.parentNode.removeChild(script);
      reject(new Error('timeout'));
    }, timeout);
    window[cbName] = function(data) {
      clearTimeout(timer);
      delete window[cbName];
      if (script.parentNode) script.parentNode.removeChild(script);
      resolve(data);
    };
    const script = document.createElement('script');
    script.src = url + (url.includes('?') ? '&' : '?') + 'callback=' + cbName;
    script.onerror = function() {
      clearTimeout(timer);
      delete window[cbName];
      if (script.parentNode) script.parentNode.removeChild(script);
      reject(new Error('script load error'));
    };
    document.head.appendChild(script);
  });
}

// â”€â”€ êµ¬ê¸€ ì‹œíŠ¸ì—ì„œ ë™ê¸°í™” â”€â”€
async function syncFromSheets() {
  const apiUrl = localStorage.getItem(API_URL_KEY);
  if (!apiUrl) return;
  showSyncBar('â³ ì‹œíŠ¸ ë™ê¸°í™” ì¤‘...');
  try {
    const json = await jsonpFetch(`${apiUrl}?sheet=exercise&action=read`);
    if (json.ok && !writePending) {
      allRecords = json.data || [];
      localStorage.setItem('exercise_records', JSON.stringify(allRecords));
      renderRecords();
      hideSyncBar();
    } else {
      showSyncBar('âš ï¸ ì„œë²„ ì˜¤ë¥˜: ' + json.error, 'error');
      setTimeout(hideSyncBar, 3000);
    }
  } catch(e) {
    showSyncBar('âš ï¸ ì˜¤í”„ë¼ì¸ â€” ë¡œì»¬ ë°ì´í„° ì‚¬ìš© ì¤‘', 'error');
    setTimeout(hideSyncBar, 3000);
  }
}

// â”€â”€ API ë™ê¸°í™” â”€â”€
async function syncToSheet(record) {
  const apiUrl = localStorage.getItem(API_URL_KEY);
  if (!apiUrl) return false;
  const params = new URLSearchParams({
    sheet: 'exercise', action: 'write',
    datetime: record.datetime,
    exercise_type: record.exercise_type,
    name: record.name,
    duration: record.duration,
    sets: record.sets != null ? record.sets : '',
    distance_km: record.distance_km != null ? record.distance_km : '',
    notes: record.notes || ''
  });
  try {
    const data = await jsonpFetch(`${apiUrl}?${params}`);
    return data.ok === true;
  } catch { return false; }
}

async function deleteFromSheet(datetime, name) {
  const apiUrl = localStorage.getItem(API_URL_KEY);
  if (!apiUrl) return false;
  const params = new URLSearchParams({ sheet: 'exercise', action: 'delete', datetime, name });
  try {
    const data = await jsonpFetch(`${apiUrl}?${params}`);
    return data.ok !== false;
  } catch { return false; }
}

// â”€â”€ ë™ê¸°í™” ìƒíƒœ ë°” â”€â”€
function showSyncBar(msg, type = '') {
  const bar = document.getElementById('sync-bar');
  bar.textContent = msg;
  bar.className = 'show' + (type ? ' ' + type : '');
  if (type === 'synced') setTimeout(hideSyncBar, 3000);
}

function hideSyncBar() {
  document.getElementById('sync-bar').className = '';
}

// â”€â”€ ì €ì¥ â”€â”€
async function saveRecord() {
  let name, duration;

  if (currentType === 'isometric') {
    const sel = document.getElementById('iso-name').value;
    name = sel === 'ê¸°íƒ€' ? document.getElementById('iso-custom').value.trim() : sel;
    duration = parseInt(document.getElementById('iso-duration').value);
    if (!name) return showToast('ìš´ë™ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”');
    if (!duration || duration < 1) return showToast('ìœ ì§€ ì‹œê°„ì„ ì…ë ¥í•˜ì„¸ìš” (ì´ˆ)');
  } else {
    const sel = document.getElementById('cardio-name').value;
    name = sel === 'ê¸°íƒ€' ? document.getElementById('cardio-custom').value.trim() : sel;
    duration = parseInt(document.getElementById('cardio-duration').value);
    if (!name) return showToast('ìš´ë™ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”');
    if (!duration || duration < 1) return showToast('ìš´ë™ ì‹œê°„ì„ ì…ë ¥í•˜ì„¸ìš” (ë¶„)');
  }

  const sets = currentType === 'isometric'
    ? (parseInt(document.getElementById('iso-sets').value) || null)
    : null;
  const distance_km = currentType === 'cardio'
    ? (parseFloat(document.getElementById('cardio-distance').value) || null)
    : null;
  const notes = document.getElementById('notes').value.trim();

  const apiUrl = localStorage.getItem(API_URL_KEY);
  if (!apiUrl) { showSyncBar('âš ï¸ ì„¤ì •ì—ì„œ Apps Script URLì„ ë¨¼ì € ì…ë ¥í•˜ì„¸ìš”'); return; }

  const record = {
    datetime: currentDatetime,
    exercise_type: currentType,
    name, duration, sets, distance_km, notes
  };

  // 1. ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì— ì¦‰ì‹œ ì €ì¥ & ë Œë”ë§
  allRecords = [record, ...allRecords];
  localStorage.setItem('exercise_records', JSON.stringify(allRecords));
  if (currentType === 'isometric') {
    document.getElementById('iso-duration').value = '';
    document.getElementById('iso-sets').value = '';
  } else {
    document.getElementById('cardio-duration').value = '';
    document.getElementById('cardio-distance').value = '';
  }
  document.getElementById('notes').value = '';
  setNow();
  renderRecords();
  showToast('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');

  // 2. êµ¬ê¸€ ì‹œíŠ¸ ë™ê¸°í™” (ë°±ê·¸ë¼ìš´ë“œ)
  showSyncBar('â˜ï¸ êµ¬ê¸€ ì‹œíŠ¸ ë™ê¸°í™” ì¤‘...');
  writePending = true;
  const ok = await syncToSheet(record);
  writePending = false;
  if (ok) {
    showSyncBar('âœ… ì‹œíŠ¸ ë™ê¸°í™” ì™„ë£Œ', 'synced');
  } else {
    showSyncBar('âš ï¸ ì‹œíŠ¸ ë™ê¸°í™” ì‹¤íŒ¨ â€” ë¡œì»¬ì—ëŠ” ì €ì¥ë¨', 'error');
    setTimeout(hideSyncBar, 4000);
  }
}

// â”€â”€ ì‚­ì œ â”€â”€
async function deleteRecord(datetime, name) {
  if (!confirm('ì´ ê¸°ë¡ì„ ì‚­ì œí• ê¹Œìš”?')) return;

  // 1. ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì—ì„œ ì¦‰ì‹œ ì‚­ì œ & ë Œë”ë§
  allRecords = allRecords.filter(r => r.datetime !== datetime);
  localStorage.setItem('exercise_records', JSON.stringify(allRecords));
  renderRecords();
  showToast('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');

  // 2. êµ¬ê¸€ ì‹œíŠ¸ ì‚­ì œ (ë°±ê·¸ë¼ìš´ë“œ)
  const apiUrl = localStorage.getItem(API_URL_KEY);
  if (apiUrl) {
    showSyncBar('ğŸ—‘ êµ¬ê¸€ ì‹œíŠ¸ì—ì„œ ì‚­ì œ ì¤‘...');
    writePending = true;
    const ok = await deleteFromSheet(datetime, name);
    writePending = false;
    if (ok) {
      hideSyncBar();
    } else {
      showSyncBar('âš ï¸ ì‹œíŠ¸ ì‚­ì œ ì‹¤íŒ¨ â€” ì¬ì‹œë„ í•„ìš”', 'error');
      setTimeout(hideSyncBar, 4000);
    }
  }
}

// â”€â”€ ë Œë”ë§ â”€â”€
function renderRecords() {
  const records = getDateRecords();
  const container = document.getElementById('records-list');

  if (records.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <div class="icon">ğŸ‹ï¸</div>
        <div>ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</div>
      </div>`;
    return;
  }

  container.innerHTML = records.map(r => {
    const isIso = r.exercise_type === 'isometric';
    const accent    = isIso ? '#6d28d9' : '#059669';
    const badgeBg   = isIso ? '#ede9fe' : '#d1fae5';
    const badgeColor = isIso ? '#5b21b6' : '#065f46';
    const badgeLabel = isIso ? 'ë“±ì²™ì„±' : 'ìœ ì‚°ì†Œ';
    const icon = isIso ? 'ğŸ§±' : 'ğŸƒ';

    const detailParts = [];
    if (isIso) {
      detailParts.push(`${r.duration}ì´ˆ`);
      if (r.sets) detailParts.push(`${r.sets}ì„¸íŠ¸`);
    } else {
      detailParts.push(`${r.duration}ë¶„`);
      if (r.distance_km) detailParts.push(`${r.distance_km}km`);
    }
    if (r.notes) detailParts.push(r.notes);

    const safeName = r.name.replace(/'/g, "\\'");

    return `
      <div class="record-item">
        <div class="record-accent" style="background:${accent}"></div>
        <div class="record-left">
          <div class="record-name">${icon} ${r.name}</div>
          <div class="record-meta">${formatDt(r.datetime)}</div>
        </div>
        <div class="record-right">
          <div class="record-badge" style="background:${badgeBg}; color:${badgeColor}">${badgeLabel}</div>
          <div class="record-detail">${detailParts.join(' Â· ')}</div>
        </div>
        <button class="delete-btn" onclick="deleteRecord('${r.datetime}', '${safeName}')" title="ì‚­ì œ">âœ•</button>
      </div>`;
  }).join('');
}

// â”€â”€ í† ìŠ¤íŠ¸ â”€â”€
function showToast(msg) {
  const toast = document.getElementById('toast');
  toast.textContent = msg;
  toast.classList.add('show');
  setTimeout(() => toast.classList.remove('show'), 2200);
}

// â”€â”€ ì´ˆê¸°í™” â”€â”€
function init() {
  document.getElementById('date-display').textContent = displayDate(currentDate);
  setNow();
  initSelectListeners();
  // 1. ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì—ì„œ ì¦‰ì‹œ ë¡œë“œ
  allRecords = JSON.parse(localStorage.getItem('exercise_records') || '[]');
  renderRecords();
  // 2. êµ¬ê¸€ ì‹œíŠ¸ì—ì„œ ë°±ê·¸ë¼ìš´ë“œ ë™ê¸°í™”
  syncFromSheets();
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./sw.js').catch(() => {});
  }
}

document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
