<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#1e293b">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>ê±´ê°• ëŒ€ì‹œë³´ë“œ</title>
  <link rel="manifest" href="manifest.json">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --blue: #1e40af; --blue-l: #3b82f6;
      --green: #065f46; --green-l: #10b981;
      --purple: #6d28d9; --purple-l: #8b5cf6;
      --red: #dc2626; --orange: #ea580c; --yellow: #d97706;
      --gray-50: #f8fafc; --gray-100: #f1f5f9; --gray-200: #e2e8f0;
      --gray-400: #94a3b8; --gray-600: #475569; --gray-800: #1e293b;
    }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
           background: var(--gray-50); color: var(--gray-800);
           min-height: 100vh; max-width: 480px; margin: 0 auto; }

    header { background: var(--gray-800); color: white; padding: 16px 20px;
             position: sticky; top: 0; z-index: 100;
             display: flex; align-items: center; justify-content: space-between; }
    header h1 { font-size: 1.1rem; font-weight: 600; }
    .sync-btn { background: rgba(255,255,255,0.15); border: none; color: white;
                padding: 6px 14px; border-radius: 20px; font-size: 0.8rem;
                cursor: pointer; }
    .sync-btn:active { background: rgba(255,255,255,0.3); }

    /* â”€â”€ íƒ­ â”€â”€ */
    .tabs { display: flex; background: white; border-bottom: 1px solid var(--gray-200);
            position: sticky; top: 52px; z-index: 90; }
    .tab { flex: 1; padding: 12px; text-align: center; font-size: 0.85rem;
           font-weight: 500; cursor: pointer; color: var(--gray-400);
           border-bottom: 2px solid transparent; background: none; border-top: none;
           border-left: none; border-right: none; }
    .tab.active { color: var(--blue); border-bottom-color: var(--blue); }
    .tab.active.tab-exercise { color: var(--purple); border-bottom-color: var(--purple); }

    /* â”€â”€ ê¸°ê°„ í•„í„° â”€â”€ */
    .range-bar { display: flex; gap: 8px; padding: 12px 16px;
                 overflow-x: auto; scrollbar-width: none; }
    .range-bar::-webkit-scrollbar { display: none; }
    .range-pill { padding: 6px 14px; border-radius: 20px; font-size: 0.78rem;
                  font-weight: 600; border: 1.5px solid var(--gray-200);
                  background: white; cursor: pointer; white-space: nowrap;
                  color: var(--gray-600); }
    .range-pill.active { background: var(--blue); color: white; border-color: var(--blue); }
    .tab-panel[data-tab="food"] .range-pill.active { background: var(--green); border-color: var(--green); }
    #tab-exercise .range-pill.active { background: var(--purple); color: white; border-color: var(--purple); }

    /* â”€â”€ ì¹´ë“œ â”€â”€ */
    .card { background: white; border-radius: 16px; margin: 0 16px 14px;
            padding: 18px; box-shadow: 0 1px 4px rgba(0,0,0,0.07); }
    .card-title { font-size: 0.78rem; font-weight: 600; color: var(--gray-400);
                  text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 14px; }

    /* â”€â”€ í†µê³„ ê·¸ë¦¬ë“œ â”€â”€ */
    .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .stat-box { background: var(--gray-50); border-radius: 12px; padding: 12px; }
    .stat-label { font-size: 0.72rem; color: var(--gray-400); font-weight: 600;
                  text-transform: uppercase; letter-spacing: 0.04em; margin-bottom: 4px; }
    .stat-val { font-size: 1.4rem; font-weight: 700; }
    .stat-sub { font-size: 0.75rem; color: var(--gray-400); margin-top: 2px; }

    /* â”€â”€ ì°¨íŠ¸ â”€â”€ */
    .chart-wrap { position: relative; height: 220px; }

    /* â”€â”€ ë¶„ë¥˜ ë²”ë¡€ â”€â”€ */
    .legend { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 12px; }
    .legend-item { display: flex; align-items: center; gap: 4px; font-size: 0.72rem; color: var(--gray-600); }
    .legend-dot { width: 10px; height: 10px; border-radius: 50%; }

    /* â”€â”€ ê¸°ë¡ í…Œì´ë¸” â”€â”€ */
    .records-table { width: 100%; border-collapse: collapse; font-size: 0.82rem; }
    .records-table th { text-align: left; padding: 6px 8px; color: var(--gray-400);
                        font-weight: 600; font-size: 0.72rem;
                        border-bottom: 1px solid var(--gray-200); }
    .records-table td { padding: 8px; border-bottom: 1px solid var(--gray-100); }
    .records-table tr:last-child td { border-bottom: none; }
    .bp-badge { padding: 2px 8px; border-radius: 10px; font-size: 0.7rem; font-weight: 600; }

    /* â”€â”€ ë‚˜íŠ¸ë¥¨ ë°” ì°¨íŠ¸ â”€â”€ */
    .na-bars { display: flex; flex-direction: column; gap: 10px; }
    .na-bar-row { display: flex; align-items: center; gap: 10px; }
    .na-bar-label { font-size: 0.78rem; color: var(--gray-600); width: 36px; flex-shrink: 0; }
    .na-bar-track { flex: 1; height: 12px; background: var(--gray-100); border-radius: 6px; overflow: hidden; }
    .na-bar-fill { height: 100%; border-radius: 6px; transition: width 0.4s; }
    .na-bar-val { font-size: 0.75rem; color: var(--gray-600); width: 58px; text-align: right; flex-shrink: 0; }

    /* â”€â”€ ìŒì‹ ë­í‚¹ â”€â”€ */
    .food-rank { display: flex; flex-direction: column; gap: 8px; }
    .food-rank-item { display: flex; align-items: center; justify-content: space-between;
                      padding: 10px 12px; background: var(--gray-50); border-radius: 10px; }
    .food-rank-left { display: flex; align-items: center; gap: 10px; }
    .rank-num { font-size: 0.75rem; font-weight: 700; color: var(--gray-400); width: 18px; }
    .food-rank-name { font-size: 0.88rem; font-weight: 500; }
    .food-rank-count { font-size: 0.72rem; color: var(--gray-400); }
    .food-rank-na { font-size: 0.85rem; font-weight: 600; color: var(--red); }

    /* â”€â”€ ë¡œë”©/ë¹ˆ ìƒíƒœ â”€â”€ */
    .loading { text-align: center; padding: 40px; color: var(--gray-400); }
    .empty { text-align: center; padding: 30px; color: var(--gray-400); font-size: 0.88rem; }

    /* â”€â”€ í•˜ë‹¨ ë„¤ë¹„ â”€â”€ */
    .bottom-nav { position: fixed; bottom: 0; left: 50%; transform: translateX(-50%);
                  width: 100%; max-width: 480px; background: white;
                  border-top: 1px solid var(--gray-200); display: flex; }
    .nav-btn { flex: 1; display: flex; flex-direction: column; align-items: center;
               padding: 10px 4px; background: none; border: none; cursor: pointer;
               color: var(--gray-400); font-size: 0.65rem; gap: 2px; text-decoration: none; }
    .nav-btn.active { color: var(--gray-800); }
    .nav-icon { font-size: 1.25rem; }
    .bottom-pad { height: 70px; }

    /* â”€â”€ íƒ­ íŒ¨ë„ â”€â”€ */
    .tab-panel { display: none; }
    .tab-panel.active { display: block; }
  </style>
</head>
<body>

<header>
  <h1>ğŸ“Š ê±´ê°• ëŒ€ì‹œë³´ë“œ</h1>
  <button class="sync-btn" onclick="loadAll()">â†» ìƒˆë¡œê³ ì¹¨</button>
</header>

<!-- íƒ­ -->
<div class="tabs">
  <button class="tab active" onclick="switchTab('bp',this)">â¤ï¸ í˜ˆì••</button>
  <button class="tab" onclick="switchTab('food',this)">ğŸ¥— ì˜ì–‘</button>
  <button class="tab tab-exercise" onclick="switchTab('exercise',this)">ğŸ’ª ìš´ë™</button>
</div>

<!-- í˜ˆì•• íƒ­ -->
<div class="tab-panel active" id="tab-bp">
  <div class="range-bar">
    <button class="range-pill active" onclick="setBPRange(7,this)">7ì¼</button>
    <button class="range-pill" onclick="setBPRange(30,this)">30ì¼</button>
    <button class="range-pill" onclick="setBPRange(90,this)">90ì¼</button>
    <button class="range-pill" onclick="setBPRange(9999,this)">ì „ì²´</button>
  </div>

  <div id="bp-loading" class="loading">í˜ˆì•• ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>

  <div id="bp-content" style="display:none">
    <!-- ìµœê·¼ í˜ˆì•• -->
    <div class="card">
      <div class="card-title">ìµœê·¼ í˜ˆì••</div>
      <div class="stat-grid">
        <div class="stat-box">
          <div class="stat-label">ìµœê·¼ ìˆ˜ì¶•ê¸°</div>
          <div class="stat-val" id="last-sbp">â€”</div>
          <div class="stat-sub">mmHg</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">ìµœê·¼ ì´ì™„ê¸°</div>
          <div class="stat-val" id="last-dbp">â€”</div>
          <div class="stat-sub">mmHg</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">í‰ê·  ìˆ˜ì¶•ê¸°</div>
          <div class="stat-val" id="avg-sbp">â€”</div>
          <div class="stat-sub">mmHg</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">í‰ê·  ì´ì™„ê¸°</div>
          <div class="stat-val" id="avg-dbp">â€”</div>
          <div class="stat-sub">mmHg</div>
        </div>
      </div>
    </div>

    <!-- í˜ˆì•• ì¶”ì´ ì°¨íŠ¸ -->
    <div class="card">
      <div class="card-title">í˜ˆì•• ì¶”ì´</div>
      <div class="chart-wrap"><canvas id="bp-chart"></canvas></div>
      <div class="legend">
        <div class="legend-item"><div class="legend-dot" style="background:#3b82f6"></div> ìˆ˜ì¶•ê¸°</div>
        <div class="legend-item"><div class="legend-dot" style="background:#10b981"></div> ì´ì™„ê¸°</div>
        <div class="legend-item"><div class="legend-dot" style="background:rgba(239,68,68,0.2)"></div> ê³ í˜ˆì•• ê¸°ì¤€ì„ </div>
      </div>
    </div>

    <!-- ë¶„ë¥˜ ë¶„í¬ -->
    <div class="card">
      <div class="card-title">ë¶„ë¥˜ ë¶„í¬</div>
      <div class="chart-wrap" style="height:180px"><canvas id="class-chart"></canvas></div>
    </div>

    <!-- ìµœê·¼ ê¸°ë¡ -->
    <div class="card">
      <div class="card-title">ìµœê·¼ ê¸°ë¡</div>
      <div id="bp-table-wrap" style="overflow-x:auto">
        <table class="records-table">
          <thead><tr><th>ë‚ ì§œ</th><th>SBP</th><th>DBP</th><th>ë¶„ë¥˜</th></tr></thead>
          <tbody id="bp-tbody"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- ì˜ì–‘ íƒ­ -->
<div class="tab-panel" id="tab-food">
  <div class="range-bar">
    <button class="range-pill active" onclick="setFoodRange(7,this)">7ì¼</button>
    <button class="range-pill" onclick="setFoodRange(30,this)">30ì¼</button>
    <button class="range-pill" onclick="setFoodRange(90,this)">90ì¼</button>
  </div>

  <div id="food-loading" class="loading">ì‹ì‚¬ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>

  <div id="food-content" style="display:none">
    <!-- ê¸°ê°„ í‰ê·  -->
    <div class="card">
      <div class="card-title">ì¼ í‰ê·  ì„­ì·¨</div>
      <div class="stat-grid">
        <div class="stat-box">
          <div class="stat-label" id="avg-na-label">ë‚˜íŠ¸ë¥¨</div>
          <div class="stat-val" id="avg-na" style="color:var(--red)">â€”</div>
          <div class="stat-sub">mg / 2,000mg ê¶Œì¥</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">ì¹¼ë¡œë¦¬</div>
          <div class="stat-val" id="avg-cal">â€”</div>
          <div class="stat-sub">kcal</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">ë‹¹ë¥˜</div>
          <div class="stat-val" id="avg-sugar">â€”</div>
          <div class="stat-sub">g</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">ì§€ë°©</div>
          <div class="stat-val" id="avg-fat">â€”</div>
          <div class="stat-sub">g</div>
        </div>
      </div>
    </div>

    <!-- ì¼ë³„ ë‚˜íŠ¸ë¥¨ ì¶”ì´ -->
    <div class="card">
      <div class="card-title">ì¼ë³„ ë‚˜íŠ¸ë¥¨ ì„­ì·¨ (mg)</div>
      <div class="chart-wrap"><canvas id="na-chart"></canvas></div>
    </div>

    <!-- ì¼ë³„ ë‚˜íŠ¸ë¥¨ ë°” -->
    <div class="card">
      <div class="card-title">ìµœê·¼ 7ì¼ ë‚˜íŠ¸ë¥¨</div>
      <div class="na-bars" id="na-bars"></div>
    </div>

    <!-- ë‚˜íŠ¸ë¥¨ TOP 10 ìŒì‹ -->
    <div class="card">
      <div class="card-title">ë‚˜íŠ¸ë¥¨ ë†’ì€ ìŒì‹ TOP 10</div>
      <div class="food-rank" id="food-rank"></div>
    </div>

    <!-- ì¹¼ë¡œë¦¬ ì°¨íŠ¸ -->
    <div class="card">
      <div class="card-title">ì¼ë³„ ì¹¼ë¡œë¦¬ (kcal)</div>
      <div class="chart-wrap"><canvas id="cal-chart"></canvas></div>
    </div>
  </div>
</div>

<!-- ìš´ë™ íƒ­ -->
<div class="tab-panel" id="tab-exercise">
  <div class="range-bar">
    <button class="range-pill active" onclick="setExerciseRange(7,this)">7ì¼</button>
    <button class="range-pill" onclick="setExerciseRange(30,this)">30ì¼</button>
    <button class="range-pill" onclick="setExerciseRange(90,this)">90ì¼</button>
  </div>

  <div id="exercise-loading" class="loading">ìš´ë™ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>

  <div id="exercise-content" style="display:none">
    <!-- ìš”ì•½ í†µê³„ -->
    <div class="card">
      <div class="card-title">ìš´ë™ ìš”ì•½</div>
      <div class="stat-grid">
        <div class="stat-box">
          <div class="stat-label">ì´ ìš´ë™ íšŸìˆ˜</div>
          <div class="stat-val" id="ex-total" style="color:var(--purple)">â€”</div>
          <div class="stat-sub">íšŒ</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">ìš´ë™í•œ ë‚ </div>
          <div class="stat-val" id="ex-days">â€”</div>
          <div class="stat-sub">ì¼</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">ğŸ§± ë“±ì²™ì„±</div>
          <div class="stat-val" id="ex-iso">â€”</div>
          <div class="stat-sub">íšŒ</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">ğŸƒ ìœ ì‚°ì†Œ</div>
          <div class="stat-val" id="ex-cardio">â€”</div>
          <div class="stat-sub">íšŒ</div>
        </div>
      </div>
    </div>

    <!-- ìœ ì‚°ì†Œ í•©ê³„ -->
    <div class="card" id="ex-cardio-card">
      <div class="card-title">ìœ ì‚°ì†Œ í•©ê³„</div>
      <div class="stat-grid">
        <div class="stat-box">
          <div class="stat-label">ì´ ìš´ë™ ì‹œê°„</div>
          <div class="stat-val" id="ex-total-min" style="color:var(--green)">â€”</div>
          <div class="stat-sub">ë¶„</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">ì´ ê±°ë¦¬</div>
          <div class="stat-val" id="ex-total-km" style="color:var(--green)">â€”</div>
          <div class="stat-sub">km</div>
        </div>
      </div>
    </div>

    <!-- ì¼ë³„ ìš´ë™ íšŸìˆ˜ ì°¨íŠ¸ -->
    <div class="card">
      <div class="card-title">ì¼ë³„ ìš´ë™ íšŸìˆ˜</div>
      <div class="chart-wrap"><canvas id="ex-daily-chart"></canvas></div>
      <div class="legend" style="margin-top:10px">
        <div class="legend-item"><div class="legend-dot" style="background:#6d28d9"></div> ë“±ì²™ì„±</div>
        <div class="legend-item"><div class="legend-dot" style="background:#10b981"></div> ìœ ì‚°ì†Œ</div>
      </div>
    </div>

    <!-- ìš´ë™ ìœ í˜• ë¶„í¬ -->
    <div class="card">
      <div class="card-title">ìš´ë™ ì¢…ëª© ë¶„í¬</div>
      <div class="chart-wrap" style="height:200px"><canvas id="ex-type-chart"></canvas></div>
    </div>

    <!-- ìì£¼ í•œ ìš´ë™ ë­í‚¹ -->
    <div class="card">
      <div class="card-title">ìì£¼ í•œ ìš´ë™</div>
      <div class="food-rank" id="ex-rank"></div>
    </div>

    <!-- ìµœê·¼ ê¸°ë¡ -->
    <div class="card">
      <div class="card-title">ìµœê·¼ ê¸°ë¡</div>
      <div style="overflow-x:auto">
        <table class="records-table">
          <thead><tr><th>ë‚ ì§œ</th><th>ìš´ë™</th><th>ìœ í˜•</th><th>ì‹œê°„</th></tr></thead>
          <tbody id="ex-tbody"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<div class="bottom-pad"></div>

<nav class="bottom-nav">
  <a href="index.html" class="nav-btn"><span class="nav-icon">â¤ï¸</span><span>í˜ˆì••</span></a>
  <a href="food.html" class="nav-btn"><span class="nav-icon">ğŸ¥—</span><span>ì‹ì‚¬</span></a>
  <a href="meds.html" class="nav-btn"><span class="nav-icon">ğŸ’Š</span><span>ì•½</span></a>
  <a href="exercise.html" class="nav-btn"><span class="nav-icon">ğŸ’ª</span><span>ìš´ë™</span></a>
  <button class="nav-btn active"><span class="nav-icon">ğŸ“Š</span><span>ëŒ€ì‹œë³´ë“œ</span></button>
</nav>

<script>
// â”€â”€ ìƒíƒœ â”€â”€
let bpData       = [];
let foodData     = [];
let exerciseData = [];
let bpRange       = 7;
let foodRange     = 7;
let exerciseRange = 7;
let bpChart, classChart, naChart, calChart, exDailyChart, exTypeChart;
const API_KEY = 'bp_api_url';

// â”€â”€ íƒ­ â”€â”€
function switchTab(name, btn) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
  btn.classList.add('active');
  document.getElementById('tab-' + name).classList.add('active');
  // ìš´ë™ íƒ­ ì²« ì§„ì… ì‹œ ë¡œë“œ
  if (name === 'exercise' && exerciseData.length === 0) loadExercise();
}

// â”€â”€ ê¸°ê°„ â”€â”€
function setBPRange(n, btn) {
  bpRange = n;
  document.querySelectorAll('#tab-bp .range-pill').forEach(p => p.classList.remove('active'));
  btn.classList.add('active');
  renderBP();
}
function setFoodRange(n, btn) {
  foodRange = n;
  document.querySelectorAll('#tab-food .range-pill').forEach(p => p.classList.remove('active'));
  btn.classList.add('active');
  renderFood();
}
function setExerciseRange(n, btn) {
  exerciseRange = n;
  document.querySelectorAll('#tab-exercise .range-pill').forEach(p => p.classList.remove('active'));
  btn.classList.add('active');
  renderExercise();
}

// â”€â”€ ë°ì´í„° ë¡œë“œ â”€â”€
async function loadAll() {
  const url = localStorage.getItem(API_KEY);

  // 1. ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì—ì„œ ì¦‰ì‹œ ë Œë”ë§
  bpData   = JSON.parse(localStorage.getItem('bp_records')   || '[]');
  foodData = JSON.parse(localStorage.getItem('food_records') || '[]');
  renderBP();
  renderFood();

  // 2. êµ¬ê¸€ ì‹œíŠ¸ì—ì„œ ë°±ê·¸ë¼ìš´ë“œ ë™ê¸°í™”
  if (!url) return;
  try {
    const [bpRes, foodRes] = await Promise.all([
      fetch(`${url}?action=read`),
      fetch(`${url}?sheet=food&action=read`)
    ]);
    const bpJson   = await bpRes.json();
    const foodJson = await foodRes.json();

    let updated = false;
    if (bpJson.ok) {
      bpData = bpJson.data;
      localStorage.setItem('bp_records', JSON.stringify(bpData));
      updated = true;
    }
    if (foodJson.ok) {
      foodData = foodJson.data;
      localStorage.setItem('food_records', JSON.stringify(foodData));
      updated = true;
    }
    if (updated) { renderBP(); renderFood(); }
  } catch {
    // ì˜¤í”„ë¼ì¸ - ë¡œì»¬ ë°ì´í„° ìœ ì§€
  }
}

async function loadExercise() {
  const url = localStorage.getItem(API_KEY);

  // 1. ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì—ì„œ ì¦‰ì‹œ ë Œë”ë§
  exerciseData = JSON.parse(localStorage.getItem('exercise_records') || '[]');
  renderExercise();

  // 2. êµ¬ê¸€ ì‹œíŠ¸ì—ì„œ ë°±ê·¸ë¼ìš´ë“œ ë™ê¸°í™”
  if (!url) return;
  try {
    const res  = await fetch(`${url}?sheet=exercise&action=read`);
    const json = await res.json();
    if (json.ok) {
      exerciseData = json.data;
      localStorage.setItem('exercise_records', JSON.stringify(exerciseData));
      renderExercise();
    }
  } catch {
    // ì˜¤í”„ë¼ì¸ - ë¡œì»¬ ë°ì´í„° ìœ ì§€
  }
}

// â”€â”€ í˜ˆì•• ë¶„ë¥˜ â”€â”€
function classifyBP(sbp, dbp) {
  if (sbp >= 160 || dbp >= 100) return { label: '2ê¸°',   color: '#991b1b', bg: '#fee2e2' };
  if (sbp >= 140 || dbp >= 90)  return { label: '1ê¸°',   color: '#9a3412', bg: '#ffedd5' };
  if (sbp >= 130 || dbp >= 80)  return { label: 'ì „ë‹¨ê³„', color: '#92400e', bg: '#fef9c3' };
  if (sbp >= 120 && dbp < 80)   return { label: 'ì£¼ì˜',  color: '#854d0e', bg: '#fef3c7' };
  return                                { label: 'ì •ìƒ',  color: '#065f46', bg: '#d1fae5' };
}

// â”€â”€ ë‚ ì§œ í•„í„° â”€â”€
function filterByDays(arr, days) {
  if (days >= 9999) return arr;
  const cutoff = new Date();
  cutoff.setDate(cutoff.getDate() - days);
  return arr.filter(r => new Date(r.datetime) >= cutoff);
}

function dateLabel(isoStr) {
  const d = new Date(isoStr);
  return `${d.getMonth()+1}/${d.getDate()}`;
}

// â”€â”€ ë‚ ì§œë³„ ì§‘ê³„ â”€â”€
function groupByDate(arr, field) {
  const map = {};
  arr.forEach(r => {
    const key = r.datetime.slice(0, 10);
    if (!map[key]) map[key] = { date: key, vals: [] };
    map[key].vals.push(r[field] || 0);
  });
  return Object.values(map).sort((a, b) => a.date.localeCompare(b.date));
}

function avg(arr) { return arr.length ? Math.round(arr.reduce((a,b)=>a+b,0)/arr.length) : 0; }
function sum(arr) { return arr.reduce((a,b)=>a+b,0); }

// â”€â”€ í˜ˆì•• ë Œë”ë§ â”€â”€
function renderBP() {
  const filtered = filterByDays([...bpData].sort((a,b) => new Date(a.datetime)-new Date(b.datetime)), bpRange);

  document.getElementById('bp-loading').style.display = 'none';
  document.getElementById('bp-content').style.display = 'block';

  if (filtered.length === 0) {
    document.getElementById('last-sbp').textContent = 'â€”';
    document.getElementById('last-dbp').textContent = 'â€”';
    document.getElementById('avg-sbp').textContent  = 'â€”';
    document.getElementById('avg-dbp').textContent  = 'â€”';
    document.getElementById('bp-tbody').innerHTML   = '<tr><td colspan="4" style="text-align:center;color:#94a3b8;padding:20px">ê¸°ë¡ ì—†ìŒ</td></tr>';
    return;
  }

  const last = filtered[filtered.length - 1];
  document.getElementById('last-sbp').textContent = last.systolic;
  document.getElementById('last-dbp').textContent = last.diastolic;
  document.getElementById('avg-sbp').textContent  = avg(filtered.map(r => r.systolic));
  document.getElementById('avg-dbp').textContent  = avg(filtered.map(r => r.diastolic));

  // í˜ˆì•• ì¶”ì´ ì°¨íŠ¸
  const labels = filtered.map(r => dateLabel(r.datetime));
  const sbpVals = filtered.map(r => r.systolic);
  const dbpVals = filtered.map(r => r.diastolic);

  if (bpChart) bpChart.destroy();
  bpChart = new Chart(document.getElementById('bp-chart'), {
    type: 'line',
    data: {
      labels,
      datasets: [
        { label: 'ìˆ˜ì¶•ê¸°', data: sbpVals, borderColor: '#3b82f6', backgroundColor: 'rgba(59,130,246,0.1)',
          tension: 0.3, fill: false, pointRadius: filtered.length > 30 ? 0 : 4 },
        { label: 'ì´ì™„ê¸°', data: dbpVals, borderColor: '#10b981', backgroundColor: 'rgba(16,185,129,0.1)',
          tension: 0.3, fill: false, pointRadius: filtered.length > 30 ? 0 : 4 },
        { label: 'ê³ í˜ˆì•• ê¸°ì¤€(140)', data: Array(labels.length).fill(140),
          borderColor: 'rgba(239,68,68,0.4)', borderDash: [5,5], pointRadius: 0,
          fill: false, borderWidth: 1.5 },
        { label: 'ì •ìƒ ê¸°ì¤€(120)', data: Array(labels.length).fill(120),
          borderColor: 'rgba(251,191,36,0.4)', borderDash: [4,4], pointRadius: 0,
          fill: false, borderWidth: 1 }
      ]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        y: { min: 50, max: Math.max(180, Math.max(...sbpVals) + 10),
             grid: { color: 'rgba(0,0,0,0.05)' } },
        x: { ticks: { maxTicksLimit: 8, maxRotation: 0 },
             grid: { display: false } }
      }
    }
  });

  // ë¶„ë¥˜ ë„ë„› ì°¨íŠ¸
  const counts = { 'ì •ìƒ': 0, 'ì£¼ì˜': 0, 'ê³ í˜ˆì••1': 0, 'ê³ í˜ˆì••2': 0, 'ìœ„ê¸°': 0 };
  filtered.forEach(r => { counts[classifyBP(r.systolic, r.diastolic).label]++; });
  const labels2 = Object.keys(counts).filter(k => counts[k] > 0);
  const clsColors = { 'ì •ìƒ':'#10b981','ì£¼ì˜':'#f59e0b','ì „ë‹¨ê³„':'#f97316','1ê¸°':'#ef4444','2ê¸°':'#dc2626' };

  if (classChart) classChart.destroy();
  classChart = new Chart(document.getElementById('class-chart'), {
    type: 'doughnut',
    data: {
      labels: labels2,
      datasets: [{ data: labels2.map(k => counts[k]),
                   backgroundColor: labels2.map(k => clsColors[k]),
                   borderWidth: 0 }]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: { legend: { position: 'right', labels: { font: { size: 11 }, boxWidth: 12 } } },
      cutout: '60%'
    }
  });

  // í…Œì´ë¸” (ìµœê·¼ 20ê°œ)
  const recent = [...filtered].reverse().slice(0, 20);
  document.getElementById('bp-tbody').innerHTML = recent.map(r => {
    const cls = classifyBP(r.systolic, r.diastolic);
    return `<tr>
      <td>${dateLabel(r.datetime)}</td>
      <td><strong>${r.systolic}</strong></td>
      <td><strong>${r.diastolic}</strong></td>
      <td><span class="bp-badge" style="background:${cls.bg};color:${cls.color}">${cls.label}</span></td>
    </tr>`;
  }).join('');
}

// â”€â”€ ì‹ì‚¬/ì˜ì–‘ ë Œë”ë§ â”€â”€
function renderFood() {
  const filtered = filterByDays([...foodData], foodRange);

  document.getElementById('food-loading').style.display = 'none';
  document.getElementById('food-content').style.display = 'block';

  if (filtered.length === 0) {
    document.getElementById('avg-na').textContent    = 'â€”';
    document.getElementById('avg-cal').textContent   = 'â€”';
    document.getElementById('avg-sugar').textContent = 'â€”';
    document.getElementById('avg-fat').textContent   = 'â€”';
    document.getElementById('na-bars').innerHTML     = '<div class="empty">ê¸°ë¡ ì—†ìŒ</div>';
    document.getElementById('food-rank').innerHTML   = '<div class="empty">ê¸°ë¡ ì—†ìŒ</div>';
    return;
  }

  // ë‚ ì§œë³„ ì§‘ê³„
  const days = {};
  filtered.forEach(r => {
    const key = r.datetime.slice(0, 10);
    if (!days[key]) days[key] = { na: 0, cal: 0, sugar: 0, fat: 0, carbs: 0, protein: 0, potassium: 0 };
    days[key].na        += r.sodium    || 0;
    days[key].cal       += r.calories  || 0;
    days[key].sugar     += r.sugar     || 0;
    days[key].fat       += r.fat       || 0;
    days[key].carbs     += r.carbs     || 0;
    days[key].protein   += r.protein   || 0;
    days[key].potassium += r.potassium || 0;
  });

  // ì¹¼ë¥¨ ìƒì‡„ ì ìš©: ìˆœ ë‚˜íŠ¸ë¥¨ = ì‹¤ì œ ë‚˜íŠ¸ë¥¨ - (ì¹¼ë¥¨ Ã— 0.59)
  Object.values(days).forEach(v => {
    const kOffset = Math.round(v.potassium * 0.59);
    v.netNa = Math.max(0, Math.round(v.na) - kOffset);
    v.hasK  = v.potassium > 0;
  });

  const dayList = Object.entries(days).sort(([a],[b]) => a.localeCompare(b));
  const n = dayList.length;

  // í‰ê·  (ì¹¼ë¥¨ì´ í•˜ë‚˜ë¼ë„ ìˆìœ¼ë©´ ìˆœ ë‚˜íŠ¸ë¥¨ìœ¼ë¡œ í‘œì‹œ)
  const anyK = dayList.some(([,v]) => v.hasK);
  document.getElementById('avg-na-label').textContent = anyK ? 'ìˆœ ë‚˜íŠ¸ë¥¨' : 'ë‚˜íŠ¸ë¥¨';
  document.getElementById('avg-na').textContent    = Math.round(sum(dayList.map(([,v])=> anyK ? v.netNa : Math.round(v.na))) / n).toLocaleString() + 'mg';
  document.getElementById('avg-cal').textContent   = Math.round(sum(dayList.map(([,v])=>v.cal))  / n).toLocaleString();
  document.getElementById('avg-sugar').textContent = Math.round(sum(dayList.map(([,v])=>v.sugar))/ n) + 'g';
  document.getElementById('avg-fat').textContent   = Math.round(sum(dayList.map(([,v])=>v.fat))  / n) + 'g';

  // ë‚˜íŠ¸ë¥¨ ë¼ì¸ ì°¨íŠ¸ (ì¹¼ë¥¨ ìƒì‡„ ì ìš©)
  const dLabels = dayList.map(([k]) => k.slice(5)); // MM-DD
  const naVals  = dayList.map(([,v]) => anyK ? v.netNa : Math.round(v.na));
  const calVals = dayList.map(([,v]) => Math.round(v.cal));

  if (naChart) naChart.destroy();
  naChart = new Chart(document.getElementById('na-chart'), {
    type: 'bar',
    data: {
      labels: dLabels,
      datasets: [
        { label: 'ë‚˜íŠ¸ë¥¨', data: naVals, backgroundColor: naVals.map(v =>
            v >= 2000 ? 'rgba(220,38,38,0.7)' : v >= 1500 ? 'rgba(234,88,12,0.7)' : 'rgba(59,130,246,0.6)'),
          borderRadius: 6 },
        { label: 'ê¶Œì¥(2000mg)', data: Array(dLabels.length).fill(2000),
          type: 'line', borderColor: 'rgba(220,38,38,0.5)', borderDash: [5,4],
          pointRadius: 0, fill: false, borderWidth: 1.5 }
      ]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        y: { grid: { color: 'rgba(0,0,0,0.05)' } },
        x: { ticks: { maxTicksLimit: 10, maxRotation: 0 }, grid: { display: false } }
      }
    }
  });

  // ì¹¼ë¡œë¦¬ ì°¨íŠ¸
  if (calChart) calChart.destroy();
  calChart = new Chart(document.getElementById('cal-chart'), {
    type: 'bar',
    data: {
      labels: dLabels,
      datasets: [{ label: 'ì¹¼ë¡œë¦¬', data: calVals,
                   backgroundColor: 'rgba(16,185,129,0.6)', borderRadius: 6 }]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        y: { grid: { color: 'rgba(0,0,0,0.05)' } },
        x: { ticks: { maxTicksLimit: 10, maxRotation: 0 }, grid: { display: false } }
      }
    }
  });

  // ìµœê·¼ 7ì¼ ë‚˜íŠ¸ë¥¨ ë°” (ì¹¼ë¥¨ ìƒì‡„ ì ìš©)
  const recent7 = dayList.slice(-7);
  const maxNa   = Math.max(...recent7.map(([,v]) => anyK ? v.netNa : v.na), 2000);
  document.getElementById('na-bars').innerHTML = recent7.map(([k, v]) => {
    const displayNa = anyK ? v.netNa : Math.round(v.na);
    const pct   = Math.min((displayNa / maxNa) * 100, 100);
    const color = displayNa >= 2000 ? '#dc2626' : displayNa >= 1500 ? '#f97316' : '#3b82f6';
    const label = k.slice(5); // MM-DD
    const kTag  = v.hasK ? ` <span style="font-size:0.68rem;color:#059669">ğŸŒ-${Math.round(v.potassium*0.59)}mg</span>` : '';
    return `
      <div class="na-bar-row">
        <div class="na-bar-label">${label}</div>
        <div class="na-bar-track">
          <div class="na-bar-fill" style="width:${pct}%; background:${color}"></div>
        </div>
        <div class="na-bar-val" style="color:${color}">${displayNa.toLocaleString()}mg${kTag}</div>
      </div>`;
  }).join('');

  // ë‚˜íŠ¸ë¥¨ TOP 10 ìŒì‹
  const foodMap = {};
  filtered.forEach(r => {
    const k = r.food_name;
    if (!foodMap[k]) foodMap[k] = { count: 0, totalNa: 0 };
    foodMap[k].count++;
    foodMap[k].totalNa += r.sodium || 0;
  });
  const top10 = Object.entries(foodMap)
    .map(([name, v]) => ({ name, count: v.count, avgNa: Math.round(v.totalNa / v.count) }))
    .sort((a, b) => b.avgNa - a.avgNa)
    .slice(0, 10);

  document.getElementById('food-rank').innerHTML = top10.length === 0
    ? '<div class="empty">ê¸°ë¡ ì—†ìŒ</div>'
    : top10.map((f, i) => `
      <div class="food-rank-item">
        <div class="food-rank-left">
          <div class="rank-num">${i + 1}</div>
          <div>
            <div class="food-rank-name">${f.name}</div>
            <div class="food-rank-count">${f.count}íšŒ ì„­ì·¨</div>
          </div>
        </div>
        <div class="food-rank-na">Na ${f.avgNa.toLocaleString()}mg</div>
      </div>`).join('');
}

// â”€â”€ ìš´ë™ ë Œë”ë§ â”€â”€
function renderExercise() {
  const filtered = filterByDays([...exerciseData], exerciseRange);

  document.getElementById('exercise-loading').style.display = 'none';
  document.getElementById('exercise-content').style.display = 'block';

  if (filtered.length === 0) {
    ['ex-total','ex-days','ex-iso','ex-cardio','ex-total-min','ex-total-km'].forEach(id => {
      document.getElementById(id).textContent = 'â€”';
    });
    document.getElementById('ex-rank').innerHTML  = '<div class="empty">ê¸°ë¡ ì—†ìŒ</div>';
    document.getElementById('ex-tbody').innerHTML = '<tr><td colspan="4" style="text-align:center;color:#94a3b8;padding:20px">ê¸°ë¡ ì—†ìŒ</td></tr>';
    return;
  }

  // â”€â”€ ìš”ì•½ í†µê³„ â”€â”€
  const isoList    = filtered.filter(r => r.exercise_type === 'isometric');
  const cardioList = filtered.filter(r => r.exercise_type === 'cardio');
  const uniqueDays = new Set(filtered.map(r => r.datetime.slice(0,10))).size;

  document.getElementById('ex-total').textContent   = filtered.length;
  document.getElementById('ex-days').textContent    = uniqueDays;
  document.getElementById('ex-iso').textContent     = isoList.length;
  document.getElementById('ex-cardio').textContent  = cardioList.length;

  // â”€â”€ ìœ ì‚°ì†Œ í•©ê³„ â”€â”€
  const totalMin = sum(cardioList.map(r => r.duration || 0));
  const totalKm  = cardioList.reduce((acc, r) => acc + (r.distance_km || 0), 0);
  document.getElementById('ex-total-min').textContent = totalMin;
  document.getElementById('ex-total-km').textContent  = totalKm > 0 ? totalKm.toFixed(1) : 'â€”';
  document.getElementById('ex-cardio-card').style.display = cardioList.length > 0 ? 'block' : 'none';

  // â”€â”€ ì¼ë³„ ìš´ë™ íšŸìˆ˜ ì°¨íŠ¸ â”€â”€
  const dayMap = {};
  filtered.forEach(r => {
    const key = r.datetime.slice(0,10);
    if (!dayMap[key]) dayMap[key] = { iso: 0, cardio: 0 };
    if (r.exercise_type === 'isometric') dayMap[key].iso++;
    else dayMap[key].cardio++;
  });
  const dayList   = Object.entries(dayMap).sort(([a],[b]) => a.localeCompare(b));
  const dayLabels = dayList.map(([k]) => k.slice(5));
  const isoVals   = dayList.map(([,v]) => v.iso);
  const cardioVals= dayList.map(([,v]) => v.cardio);

  if (exDailyChart) exDailyChart.destroy();
  exDailyChart = new Chart(document.getElementById('ex-daily-chart'), {
    type: 'bar',
    data: {
      labels: dayLabels,
      datasets: [
        { label: 'ë“±ì²™ì„±', data: isoVals,    backgroundColor: 'rgba(109,40,217,0.7)', borderRadius: 4, stack: 'ex' },
        { label: 'ìœ ì‚°ì†Œ', data: cardioVals, backgroundColor: 'rgba(16,185,129,0.7)', borderRadius: 4, stack: 'ex' }
      ]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        x: { stacked: true, ticks: { maxTicksLimit: 10, maxRotation: 0 }, grid: { display: false } },
        y: { stacked: true, ticks: { stepSize: 1 }, grid: { color: 'rgba(0,0,0,0.05)' } }
      }
    }
  });

  // â”€â”€ ì¢…ëª©ë³„ ë„ë„› ì°¨íŠ¸ â”€â”€
  const nameMap = {};
  filtered.forEach(r => {
    nameMap[r.name] = (nameMap[r.name] || 0) + 1;
  });
  const nameEntries = Object.entries(nameMap).sort((a,b) => b[1]-a[1]);
  const donutColors = ['#6d28d9','#10b981','#3b82f6','#f59e0b','#ef4444','#8b5cf6','#34d399','#60a5fa','#fbbf24','#f87171'];

  if (exTypeChart) exTypeChart.destroy();
  exTypeChart = new Chart(document.getElementById('ex-type-chart'), {
    type: 'doughnut',
    data: {
      labels: nameEntries.map(([k]) => k),
      datasets: [{ data: nameEntries.map(([,v]) => v),
                   backgroundColor: donutColors.slice(0, nameEntries.length),
                   borderWidth: 0 }]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: { legend: { position: 'right', labels: { font: { size: 11 }, boxWidth: 12 } } },
      cutout: '55%'
    }
  });

  // â”€â”€ ìì£¼ í•œ ìš´ë™ ë­í‚¹ â”€â”€
  document.getElementById('ex-rank').innerHTML = nameEntries.slice(0,8).map(([name, cnt], i) => {
    const isIso = filtered.find(r => r.name === name)?.exercise_type === 'isometric';
    const icon  = isIso ? 'ğŸ§±' : 'ğŸƒ';
    const badge = isIso ? `<span style="font-size:0.7rem;background:#ede9fe;color:#5b21b6;padding:2px 7px;border-radius:8px;font-weight:600">ë“±ì²™ì„±</span>`
                        : `<span style="font-size:0.7rem;background:#d1fae5;color:#065f46;padding:2px 7px;border-radius:8px;font-weight:600">ìœ ì‚°ì†Œ</span>`;
    return `
      <div class="food-rank-item">
        <div class="food-rank-left">
          <div class="rank-num">${i+1}</div>
          <div>
            <div class="food-rank-name">${icon} ${name}</div>
            <div class="food-rank-count">${cnt}íšŒ</div>
          </div>
        </div>
        ${badge}
      </div>`;
  }).join('');

  // â”€â”€ ìµœê·¼ ê¸°ë¡ í…Œì´ë¸” â”€â”€
  const recent = [...filtered].sort((a,b) => new Date(b.datetime)-new Date(a.datetime)).slice(0,20);
  document.getElementById('ex-tbody').innerHTML = recent.map(r => {
    const isIso  = r.exercise_type === 'isometric';
    const detail = isIso
      ? `${r.duration}ì´ˆ${r.sets ? ' Ã— '+r.sets+'ì„¸íŠ¸' : ''}`
      : `${r.duration}ë¶„${r.distance_km ? ' / '+r.distance_km+'km' : ''}`;
    const badge  = isIso
      ? `<span style="background:#ede9fe;color:#5b21b6;padding:2px 7px;border-radius:8px;font-size:0.7rem;font-weight:600">ë“±ì²™ì„±</span>`
      : `<span style="background:#d1fae5;color:#065f46;padding:2px 7px;border-radius:8px;font-size:0.7rem;font-weight:600">ìœ ì‚°ì†Œ</span>`;
    return `<tr>
      <td>${dateLabel(r.datetime)}</td>
      <td><strong>${r.name}</strong></td>
      <td>${badge}</td>
      <td style="color:var(--gray-600)">${detail}</td>
    </tr>`;
  }).join('');
}

// â”€â”€ ì´ˆê¸°í™” â”€â”€
document.addEventListener('DOMContentLoaded', () => {
  loadAll();
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./sw.js').catch(() => {});
  }
});
</script>
</body>
</html>
