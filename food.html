<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#065f46">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>ì‹ì‚¬ ê¸°ë¡</title>
  <link rel="manifest" href="manifest.json">
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --green:  #065f46; --green-l: #10b981; --green-bg: #d1fae5;
      --yellow: #d97706; --yellow-bg: #fef3c7;
      --red:    #dc2626; --red-bg: #fee2e2;
      --gray-50: #f8fafc; --gray-100: #f1f5f9; --gray-200: #e2e8f0;
      --gray-400: #94a3b8; --gray-600: #475569; --gray-800: #1e293b;
    }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
           background: var(--gray-50); color: var(--gray-800);
           min-height: 100vh; max-width: 480px; margin: 0 auto; }

    header { background: var(--green); color: white; padding: 16px 20px;
             position: sticky; top: 0; z-index: 100;
             display: flex; align-items: center; justify-content: space-between; }
    header h1 { font-size: 1.1rem; font-weight: 600; }

    /* â”€â”€ ë‚ ì§œ íƒìƒ‰ â”€â”€ */
    .date-nav { display: flex; align-items: center; justify-content: center;
                gap: 16px; padding: 12px 20px; background: white;
                border-bottom: 1px solid var(--gray-200); }
    .date-btn { background: none; border: none; font-size: 1.2rem; cursor: pointer;
                color: var(--gray-600); padding: 4px 8px; border-radius: 6px; }
    .date-btn:active { background: var(--gray-100); }
    #date-display { font-size: 0.95rem; font-weight: 600; color: var(--gray-800); }

    /* â”€â”€ ë‚˜íŠ¸ë¥¨ ìš”ì•½ ë°” â”€â”€ */
    .sodium-summary { margin: 14px 16px; background: white;
                      border-radius: 16px; padding: 16px;
                      box-shadow: 0 1px 4px rgba(0,0,0,0.07); }
    .summary-row { display: flex; justify-content: space-between; align-items: flex-end;
                   margin-bottom: 8px; }
    .summary-title { font-size: 0.78rem; font-weight: 600; color: var(--gray-400);
                     text-transform: uppercase; letter-spacing: 0.05em; }
    .summary-value { font-size: 0.85rem; color: var(--gray-600); }
    .sodium-number { font-size: 1.5rem; font-weight: 700; }
    .sodium-unit { font-size: 0.82rem; color: var(--gray-400); margin-left: 2px; }
    .progress-bar { height: 10px; background: var(--gray-100); border-radius: 5px; overflow: hidden; margin-bottom: 6px; }
    .progress-fill { height: 100%; border-radius: 5px; transition: width 0.4s; background: var(--green-l); }
    .progress-fill.warn { background: var(--yellow); }
    .progress-fill.danger { background: var(--red); }
    .nutrient-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-top: 12px; }
    .nutrient-box { background: var(--gray-50); border-radius: 10px; padding: 8px;
                    text-align: center; }
    .nutrient-box .val { font-size: 1rem; font-weight: 700; color: var(--gray-800); }
    .nutrient-box .lbl { font-size: 0.7rem; color: var(--gray-400); margin-top: 2px; }

    /* â”€â”€ ì‹ì‚¬ ì„¹ì…˜ â”€â”€ */
    .meal-section { margin: 0 16px 14px; }
    .meal-header { display: flex; align-items: center; justify-content: space-between;
                   padding: 10px 4px; }
    .meal-title { font-size: 0.95rem; font-weight: 600; color: var(--gray-800);
                  display: flex; align-items: center; gap: 6px; }
    .add-btn { background: none; border: 1px solid var(--green-l); color: var(--green);
               font-size: 0.78rem; font-weight: 600; padding: 5px 12px;
               border-radius: 20px; cursor: pointer; }
    .add-btn:active { background: var(--green-bg); }
    .food-item { background: white; border-radius: 12px;
                 padding: 12px 14px; margin-bottom: 8px;
                 box-shadow: 0 1px 3px rgba(0,0,0,0.06);
                 display: flex; align-items: center; }
    .food-item > div:first-child { flex: 1; min-width: 0; }
    .food-name { font-size: 0.95rem; font-weight: 500;
                 overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .food-sub  { font-size: 0.75rem; color: var(--gray-400); margin-top: 2px; }
    .food-right { text-align: right; flex-shrink: 0; width: 88px; padding-left: 8px; }
    .food-na  { font-size: 0.88rem; font-weight: 600; color: var(--red); }
    .food-cal { font-size: 0.75rem; color: var(--gray-400); margin-top: 2px; }
    .food-actions { display: flex; flex-direction: column; margin-left: 8px; flex-shrink: 0; gap: 2px; }
    .food-edit, .food-del { background: none; border: none; color: var(--gray-400);
                font-size: 0.8rem; cursor: pointer; padding: 3px 6px;
                border-radius: 6px; line-height: 1.4; }
    .food-edit:active { color: var(--green); background: var(--green-bg); }
    .food-del:active  { color: var(--red);   background: var(--red-bg); }
    .empty-meal { font-size: 0.82rem; color: var(--gray-400); padding: 8px 4px; }

    /* â”€â”€ ìŒì‹ ì¶”ê°€ ëª¨ë‹¬ â”€â”€ */
    .modal-overlay { display: none; position: fixed; inset: 0;
                     background: rgba(0,0,0,0.5); z-index: 200; align-items: flex-end; }
    .modal-overlay.open { display: flex; }
    .modal { background: white; border-radius: 24px 24px 0 0; width: 100%;
             max-width: 480px; margin: 0 auto; padding: 20px;
             max-height: 92vh; overflow-y: auto;
             transition: transform 0.2s;
             overscroll-behavior: contain; }
    .modal-handle { width: 40px; height: 4px; background: var(--gray-200);
                    border-radius: 2px; margin: 0 auto 16px; cursor: grab; }
    .modal-handle-area { width: 100%; padding: 4px 0 12px; margin: -4px -20px 0;
                         padding-left: 20px; padding-right: 20px; cursor: grab; }
    .modal-title { font-size: 1.05rem; font-weight: 700; margin-bottom: 16px; }

    .search-input { width: 100%; border: 2px solid var(--gray-200); border-radius: 12px;
                    padding: 12px 14px; font-size: 1rem; outline: none;
                    color: var(--gray-800); }
    .search-input:focus { border-color: var(--green-l); }

    .autocomplete { background: white; border: 1px solid var(--gray-200);
                    border-radius: 12px; margin-top: 6px; overflow: hidden;
                    display: none; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    .autocomplete.show { display: block; }
    .auto-item { padding: 12px 14px; cursor: pointer; border-bottom: 1px solid var(--gray-100);
                 display: flex; justify-content: space-between; align-items: center; }
    .auto-item:last-child { border-bottom: none; }
    .auto-item:active { background: var(--gray-50); }
    .auto-item-name { font-size: 0.9rem; font-weight: 500; }
    .auto-item-info { font-size: 0.75rem; color: var(--gray-400); }
    .auto-na { font-size: 0.78rem; color: var(--red); font-weight: 600; }

    .custom-section { margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--gray-100); }
    .custom-title { font-size: 0.8rem; font-weight: 600; color: var(--gray-400);
                    text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 12px; }
    .field-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
    .field-group label { font-size: 0.78rem; font-weight: 600; color: var(--gray-600);
                         display: block; margin-bottom: 4px; }
    .field-group input { width: 100%; border: 2px solid var(--gray-200); border-radius: 10px;
                         padding: 10px 12px; font-size: 0.95rem; outline: none; }
    .field-group input:focus { border-color: var(--green-l); }
    .field-group.full { grid-column: 1 / -1; }

    .meal-select { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 14px; }
    .meal-opt { border: 2px solid var(--gray-200); border-radius: 10px; padding: 8px 4px;
                text-align: center; font-size: 0.82rem; cursor: pointer; background: white; }
    .meal-opt.selected { border-color: var(--green-l); background: var(--green-bg);
                         color: var(--green); font-weight: 600; }

    .serving-row { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; }
    .serving-label { font-size: 0.82rem; font-weight: 600; color: var(--gray-600); white-space: nowrap; width: 28px; }
    .serving-btns { display: flex; gap: 6px; flex: 1; }
    .serving-btn { flex: 1; border: 2px solid var(--gray-200); border-radius: 10px; padding: 8px 4px;
                   text-align: center; font-size: 0.82rem; cursor: pointer; background: white; }
    .serving-btn.selected { border-color: var(--green-l); background: var(--green-bg);
                             color: var(--green); font-weight: 600; }
    .count-row { display: flex; align-items: center; gap: 10px; margin-bottom: 14px; }
    .count-input { width: 72px; border: 2px solid var(--gray-200); border-radius: 10px;
                   padding: 8px 10px; font-size: 0.95rem; text-align: center; outline: none; }
    .count-input:focus { border-color: var(--green-l); }
    .count-label { font-size: 0.82rem; color: var(--gray-600); }

    .modal-save-btn { width: 100%; background: var(--green); color: white; border: none;
                      border-radius: 14px; padding: 15px; font-size: 0.95rem;
                      font-weight: 600; cursor: pointer; margin-top: 16px; }
    .modal-save-btn:active { background: #064e3b; }

    /* â”€â”€ í•˜ë‹¨ ë„¤ë¹„ â”€â”€ */
    .bottom-nav { position: fixed; bottom: 0; left: 50%; transform: translateX(-50%);
                  width: 100%; max-width: 480px; background: white;
                  border-top: 1px solid var(--gray-200); display: flex; }
    .nav-btn { flex: 1; display: flex; flex-direction: column; align-items: center;
               padding: 10px 4px; background: none; border: none; cursor: pointer;
               color: var(--gray-400); font-size: 0.65rem; gap: 2px; text-decoration: none; }
    .nav-btn.active { color: var(--green); }
    .nav-icon { font-size: 1.25rem; }
    .bottom-pad { height: 70px; }

    /* â”€â”€ í† ìŠ¤íŠ¸ â”€â”€ */
    #toast { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%) translateY(20px);
             background: var(--gray-800); color: white; padding: 10px 20px;
             border-radius: 20px; font-size: 0.88rem; opacity: 0;
             transition: opacity 0.2s, transform 0.2s; pointer-events: none;
             white-space: nowrap; z-index: 300; }
    #toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
  </style>
</head>
<body>

<header>
  <h1>ğŸ¥— ì‹ì‚¬ ê¸°ë¡</h1>
  <div style="width:36px"></div>
</header>

<!-- ë‚ ì§œ ë„¤ë¹„ê²Œì´ì…˜ -->
<div class="date-nav">
  <button class="date-btn" onclick="changeDate(-1)">â€¹</button>
  <span id="date-display"></span>
  <button class="date-btn" onclick="changeDate(1)">â€º</button>
</div>

<!-- ì˜ì–‘ ìš”ì•½ -->
<div class="sodium-summary">
  <div class="summary-row">
    <div>
      <div class="summary-title">ì˜¤ëŠ˜ ë‚˜íŠ¸ë¥¨</div>
      <div><span class="sodium-number" id="total-na">0</span><span class="sodium-unit">mg</span>
           <span id="na-limit-text" style="font-size:0.75rem; color:var(--gray-400)"> / 2,000mg (WHO ê¶Œì¥)</span></div>
    </div>
    <div class="summary-value" id="na-percent"></div>
  </div>
  <div class="progress-bar">
    <div class="progress-fill" id="na-progress" style="width:0%"></div>
  </div>
  <div class="nutrient-grid">
    <div class="nutrient-box">
      <div class="val" id="total-cal">0</div>
      <div class="lbl">kcal ì¹¼ë¡œë¦¬</div>
    </div>
    <div class="nutrient-box">
      <div class="val" id="total-sugar">0g</div>
      <div class="lbl">ë‹¹ë¥˜</div>
    </div>
    <div class="nutrient-box">
      <div class="val" id="total-fat">0g</div>
      <div class="lbl">ì§€ë°©</div>
    </div>
  </div>
</div>

<!-- ì‹ì‚¬ ì„¹ì…˜ë“¤ -->
<div id="meals-container"></div>

<div class="bottom-pad"></div>

<!-- í•˜ë‹¨ ë„¤ë¹„ -->
<nav class="bottom-nav">
  <a href="index.html" class="nav-btn"><span class="nav-icon">â¤ï¸</span><span>í˜ˆì••</span></a>
  <button class="nav-btn active"><span class="nav-icon">ğŸ¥—</span><span>ì‹ì‚¬</span></button>
  <a href="exercise.html" class="nav-btn"><span class="nav-icon">ğŸ’ª</span><span>ìš´ë™</span></a>
  <a href="dashboard.html" class="nav-btn"><span class="nav-icon">ğŸ“Š</span><span>ëŒ€ì‹œë³´ë“œ</span></a>
</nav>

<!-- ìŒì‹ ì¶”ê°€ ëª¨ë‹¬ -->
<div class="modal-overlay" id="modal" onclick="closeModalIf(event)">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title" id="modal-title">ìŒì‹ ì¶”ê°€</div>

    <div class="meal-select" id="meal-select">
      <button class="meal-opt selected" data-meal="ì•„ì¹¨" onclick="selectMeal(this)">ğŸŒ… ì•„ì¹¨</button>
      <button class="meal-opt" data-meal="ì ì‹¬" onclick="selectMeal(this)">â˜€ï¸ ì ì‹¬</button>
      <button class="meal-opt" data-meal="ì €ë…" onclick="selectMeal(this)">ğŸŒ™ ì €ë…</button>
      <button class="meal-opt" data-meal="ê°„ì‹" onclick="selectMeal(this)">ğŸ ê°„ì‹</button>
    </div>

    <div class="serving-row">
      <span class="serving-label">ì¸ë¶„</span>
      <div class="serving-btns">
        <button class="serving-btn" data-val="0.333" onclick="setServing(1/3)">â…“</button>
        <button class="serving-btn" data-val="0.5" onclick="setServing(0.5)">Â½</button>
        <button class="serving-btn" data-val="0.667" onclick="setServing(2/3)">â…”</button>
        <button class="serving-btn selected" data-val="1" onclick="setServing(1)">1</button>
        <button class="serving-btn" data-val="1.5" onclick="setServing(1.5)">1.5</button>
        <button class="serving-btn" data-val="2" onclick="setServing(2)">2</button>
      </div>
      <span class="count-label">ì¸ë¶„</span>
    </div>
    <div class="count-row">
      <span class="serving-label">ê°œìˆ˜</span>
      <input type="number" id="food-count" class="count-input"
             value="1" min="1" max="99" inputmode="numeric"
             oninput="setCount(parseInt(this.value)||1)">
      <span class="count-label">ê°œ &nbsp;(ì¸ë¶„Ã—ê°œìˆ˜ë¡œ ì˜ì–‘ì„±ë¶„ ìë™ê³„ì‚°)</span>
    </div>

    <input type="text" id="food-search" class="search-input"
           placeholder="ìŒì‹ ì´ë¦„ ê²€ìƒ‰ (ì˜ˆ: ê¹€ì¹˜ì°Œê°œ, ë¼ë©´)"
           oninput="onSearch(this.value)" autocomplete="off">
    <div class="autocomplete" id="autocomplete"></div>

    <div class="custom-section">
      <div class="custom-title">ì§ì ‘ ì…ë ¥ ë˜ëŠ” ìˆ˜ì •</div>
      <div class="field-row">
        <div class="field-group full">
          <label>ìŒì‹ ì´ë¦„ *</label>
          <input type="text" id="f-name" placeholder="ìŒì‹ ì´ë¦„">
        </div>
      </div>
      <div class="field-row">
        <div class="field-group">
          <label>ë‚˜íŠ¸ë¥¨ (mg) *</label>
          <input type="number" id="f-na" inputmode="numeric" placeholder="0">
        </div>
        <div class="field-group">
          <label>ì¹¼ë¡œë¦¬ (kcal)</label>
          <input type="number" id="f-cal" inputmode="numeric" placeholder="0">
        </div>
      </div>
      <div class="field-row">
        <div class="field-group">
          <label>íƒ„ìˆ˜í™”ë¬¼ (g)</label>
          <input type="number" id="f-carb" inputmode="decimal" placeholder="0">
        </div>
        <div class="field-group">
          <label>ì§€ë°© (g)</label>
          <input type="number" id="f-fat" inputmode="decimal" placeholder="0">
        </div>
      </div>
      <div class="field-row">
        <div class="field-group">
          <label>ë‹¹ë¥˜ (g)</label>
          <input type="number" id="f-sugar" inputmode="decimal" placeholder="0">
        </div>
        <div class="field-group">
          <label>ë‹¨ë°±ì§ˆ (g)</label>
          <input type="number" id="f-protein" inputmode="decimal" placeholder="0">
        </div>
      </div>
      <div class="field-row">
        <div class="field-group full">
          <label>ë©”ëª¨</label>
          <input type="text" id="f-notes" placeholder="ì˜ˆ: 2ì¸ë¶„, ì†ŒëŸ‰">
        </div>
      </div>
    </div>

    <button class="modal-save-btn" onclick="saveFood()">ì¶”ê°€í•˜ê¸°</button>
  </div>
</div>

<div id="toast"></div>

<script src="foods-db.js"></script>
<script>
const FOOD_KEY = 'food_records';
const API_KEY  = 'bp_api_url';
const MEALS    = ['ì•„ì¹¨', 'ì ì‹¬', 'ì €ë…', 'ê°„ì‹'];
const MEAL_EMOJI = { 'ì•„ì¹¨': 'ğŸŒ…', 'ì ì‹¬': 'â˜€ï¸', 'ì €ë…': 'ğŸŒ™', 'ê°„ì‹': 'ğŸ' };

let currentDate = new Date();
let selectedMeal = 'ì•„ì¹¨';
let baseFood = null;
let currentServing = 1;
let currentCount = 1;
let editingDatetime = null;  // null = ìƒˆ ì¶”ê°€, string = ê¸°ì¡´ ìˆ˜ì •

// â”€â”€ ë‚ ì§œ ìœ í‹¸ â”€â”€
function dateKey(d) {
  return d.toISOString().slice(0, 10);
}
function displayDate(d) {
  const today = dateKey(new Date());
  const key   = dateKey(d);
  const label = key === today ? 'ì˜¤ëŠ˜' : key === yesterday() ? 'ì–´ì œ' : '';
  return d.toLocaleDateString('ko-KR', { month: 'long', day: 'numeric', weekday: 'short' })
         + (label ? ` (${label})` : '');
}
function yesterday() {
  const d = new Date(); d.setDate(d.getDate() - 1);
  return dateKey(d);
}
function changeDate(dir) {
  currentDate.setDate(currentDate.getDate() + dir);
  renderPage();
}

// â”€â”€ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ â”€â”€
function getRecords() {
  try { return JSON.parse(localStorage.getItem(FOOD_KEY) || '[]'); } catch { return []; }
}
function saveRecords(r) { localStorage.setItem(FOOD_KEY, JSON.stringify(r)); }

function getTodayRecords() {
  const key = dateKey(currentDate);
  return getRecords().filter(r => r.datetime.startsWith(key));
}

// â”€â”€ API ë™ê¸°í™” â”€â”€
async function syncFood(record) {
  const url = localStorage.getItem(API_KEY);
  if (!url) return false;
  const p = new URLSearchParams({ sheet: 'food', action: 'write', ...record });
  try {
    const res = await fetch(`${url}?${p}`);
    const d = await res.json();
    return d.ok;
  } catch { return false; }
}

async function deleteFromSheet(record) {
  const url = localStorage.getItem(API_KEY);
  if (!url) return;
  const p = new URLSearchParams({ sheet: 'food', action: 'delete',
    datetime: record.datetime, food_name: record.food_name });
  try { await fetch(`${url}?${p}`); } catch {}
}

// â”€â”€ ëª¨ë‹¬ ìŠ¤ì™€ì´í”„: document ë ˆë²¨ì—ì„œ pull-to-refresh ì™„ì „ ì°¨ë‹¨ â”€â”€
let _swipeStartY = 0;

function _swipeTouchStart(e) {
  _swipeStartY = e.touches[0].clientY;
}

function _swipeTouchMove(e) {
  const modalEl = document.querySelector('#modal .modal');
  if (!modalEl) return;
  // ëª¨ë‹¬ ë‚´ë¶€ë¥¼ ìŠ¤í¬ë¡¤ ì¤‘ì´ë©´ ìì—°ìŠ¤ëŸ½ê²Œ í—ˆìš©
  if (modalEl.scrollTop > 0) return;
  const dy = e.touches[0].clientY - _swipeStartY;
  if (dy > 0) {
    e.preventDefault(); // document ë ˆë²¨ì—ì„œ pull-to-refresh ì°¨ë‹¨
    modalEl.style.transition = 'none';
    modalEl.style.transform = `translateY(${dy}px)`;
  }
}

function _swipeTouchEnd(e) {
  const modalEl = document.querySelector('#modal .modal');
  if (!modalEl) return;
  const dy = e.changedTouches[0].clientY - _swipeStartY;
  modalEl.style.transition = '';
  if (dy > 80 && document.getElementById('modal').classList.contains('open')) {
    closeModal();
  } else {
    modalEl.style.transform = '';
  }
}

// â”€â”€ ëª¨ë‹¬ â”€â”€
function openModal(meal) {
  selectedMeal = meal || 'ì ì‹¬';
  document.querySelectorAll('.meal-opt').forEach(el => {
    el.classList.toggle('selected', el.dataset.meal === selectedMeal);
  });
  clearForm();
  const overlay = document.getElementById('modal');
  overlay.querySelector('.modal').style.transform = '';
  overlay.classList.add('open');
  // document ë ˆë²¨ì—ì„œ pull-to-refresh ì°¨ë‹¨ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
  document.documentElement.style.overscrollBehavior = 'none';
  document.addEventListener('touchstart', _swipeTouchStart, { passive: true });
  document.addEventListener('touchmove',  _swipeTouchMove,  { passive: false });
  document.addEventListener('touchend',   _swipeTouchEnd,   { passive: true });
  setTimeout(() => document.getElementById('food-search').focus(), 100);
}

function closeModal() {
  const modalEl = document.querySelector('#modal .modal');
  if (modalEl) modalEl.style.transform = '';
  document.getElementById('modal').classList.remove('open');
  document.getElementById('autocomplete').classList.remove('show');
  // ë¦¬ìŠ¤ë„ˆ í•´ì œ & pull-to-refresh ë³µì›
  document.documentElement.style.overscrollBehavior = '';
  document.removeEventListener('touchstart', _swipeTouchStart);
  document.removeEventListener('touchmove',  _swipeTouchMove);
  document.removeEventListener('touchend',   _swipeTouchEnd);
}

function closeModalIf(e) {
  if (e.target === document.getElementById('modal')) closeModal();
}

function selectMeal(el) {
  selectedMeal = el.dataset.meal;
  document.querySelectorAll('.meal-opt').forEach(b => b.classList.remove('selected'));
  el.classList.add('selected');
}

function clearForm() {
  ['food-search','f-name','f-na','f-cal','f-carb','f-fat','f-sugar','f-protein','f-notes']
    .forEach(id => { document.getElementById(id).value = ''; });
  document.getElementById('food-count').value = 1;
  document.getElementById('autocomplete').classList.remove('show');
  baseFood = null;
  currentServing = 1;
  currentCount = 1;
  editingDatetime = null;
  syncServingBtns(1);
  document.getElementById('modal-title').textContent = 'ìŒì‹ ì¶”ê°€';
  document.querySelector('.modal-save-btn').textContent = 'ì¶”ê°€í•˜ê¸°';
}

function syncServingBtns(val) {
  document.querySelectorAll('.serving-btn').forEach(b => {
    b.classList.toggle('selected', Math.abs(parseFloat(b.dataset.val) - val) < 0.01);
  });
}

function updateNutritionFromBase() {
  if (!baseFood) return;
  const m = currentServing * currentCount;
  document.getElementById('f-na').value      = Math.round(baseFood.na * m);
  document.getElementById('f-cal').value     = Math.round(baseFood.cal * m);
  document.getElementById('f-carb').value    = Math.round(baseFood.carb * m * 10) / 10;
  document.getElementById('f-fat').value     = Math.round(baseFood.fat * m * 10) / 10;
  document.getElementById('f-sugar').value   = Math.round(baseFood.sugar * m * 10) / 10;
  document.getElementById('f-protein').value = Math.round(baseFood.protein * m * 10) / 10;
}

function setServing(val) {
  currentServing = val;
  syncServingBtns(val);
  updateNutritionFromBase();
}

function setCount(val) {
  currentCount = Math.max(1, Math.floor(val || 1));
  document.getElementById('food-count').value = currentCount;
  updateNutritionFromBase();
}

function fmtServing(v) {
  if (!v || Math.abs(v - 1) < 0.01) return '';
  if (Math.abs(v - 1/3) < 0.01) return 'â…“ì¸ë¶„';
  if (Math.abs(v - 0.5) < 0.01) return 'Â½ì¸ë¶„';
  if (Math.abs(v - 2/3) < 0.01) return 'â…”ì¸ë¶„';
  return v + 'ì¸ë¶„';
}

// â”€â”€ ìˆ˜ì • ëª¨ë‹¬ ì—´ê¸° â”€â”€
function openEditModal(datetime) {
  const record = getRecords().find(r => r.datetime === datetime);
  if (!record) return;

  selectedMeal = record.meal;
  document.querySelectorAll('.meal-opt').forEach(el => {
    el.classList.toggle('selected', el.dataset.meal === selectedMeal);
  });

  clearForm();
  editingDatetime = datetime;

  const srv = record.servings || 1;
  const cnt = record.count   || 1;
  currentServing = srv;
  currentCount   = cnt;
  // ì¸ë¶„Ã—ê°œìˆ˜ ì—­ì‚°í•´ì„œ baseFood ë³µì› (ì¸ë¶„Â·ê°œìˆ˜ ë²„íŠ¼ ì¡°ì‘ ê°€ëŠ¥í•˜ë„ë¡)
  const totalMult = srv * cnt;
  baseFood = {
    na:      record.sodium   / totalMult,
    cal:     record.calories / totalMult,
    carb:    record.carbs    / totalMult,
    fat:     record.fat      / totalMult,
    sugar:   record.sugar    / totalMult,
    protein: record.protein  / totalMult,
  };
  syncServingBtns(srv);
  document.getElementById('food-count').value = cnt;

  document.getElementById('f-name').value    = record.food_name;
  document.getElementById('f-na').value      = record.sodium;
  document.getElementById('f-cal').value     = record.calories;
  document.getElementById('f-carb').value    = record.carbs;
  document.getElementById('f-fat').value     = record.fat;
  document.getElementById('f-sugar').value   = record.sugar;
  document.getElementById('f-protein').value = record.protein;
  document.getElementById('f-notes').value   = record.notes || '';
  document.getElementById('food-search').value = record.food_name;

  document.getElementById('modal-title').textContent = 'ìŒì‹ ìˆ˜ì •';
  document.querySelector('.modal-save-btn').textContent = 'ìˆ˜ì •í•˜ê¸°';

  const overlay = document.getElementById('modal');
  overlay.querySelector('.modal').style.transform = '';
  overlay.classList.add('open');
  document.documentElement.style.overscrollBehavior = 'none';
  document.addEventListener('touchstart', _swipeTouchStart, { passive: true });
  document.addEventListener('touchmove',  _swipeTouchMove,  { passive: false });
  document.addEventListener('touchend',   _swipeTouchEnd,   { passive: true });
}

// â”€â”€ ê²€ìƒ‰ â”€â”€
function onSearch(q) {
  const ac = document.getElementById('autocomplete');
  const results = searchFoods(q);
  if (results.length === 0) { ac.classList.remove('show'); return; }
  ac.innerHTML = results.map(f => `
    <div class="auto-item" onclick="selectFood(${JSON.stringify(f).replace(/"/g,'&quot;')})">
      <div>
        <div class="auto-item-name">${f.name}</div>
        <div class="auto-item-info">${f.unit} Â· ${f.serving}g Â· ${f.cal}kcal</div>
      </div>
      <div class="auto-na">Na ${f.na}mg</div>
    </div>`).join('');
  ac.classList.add('show');
}

function selectFood(f) {
  baseFood = f;
  currentServing = 1;
  currentCount = 1;
  syncServingBtns(1);
  document.getElementById('food-count').value = 1;
  document.getElementById('f-name').value    = f.name;
  document.getElementById('f-na').value      = f.na;
  document.getElementById('f-cal').value     = f.cal;
  document.getElementById('f-carb').value    = f.carb;
  document.getElementById('f-fat').value     = f.fat;
  document.getElementById('f-sugar').value   = f.sugar;
  document.getElementById('f-protein').value = f.protein;
  document.getElementById('food-search').value = f.name;
  document.getElementById('autocomplete').classList.remove('show');
}

// â”€â”€ ì €ì¥ (ì¶”ê°€ / ìˆ˜ì • ê³µí†µ) â”€â”€
async function saveFood() {
  const name = document.getElementById('f-name').value.trim();
  const na   = parseFloat(document.getElementById('f-na').value);
  if (!name)      return showToast('ìŒì‹ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”');
  if (isNaN(na))  return showToast('ë‚˜íŠ¸ë¥¨ ìˆ˜ì¹˜ë¥¼ ì…ë ¥í•˜ì„¸ìš”');

  const isEditing = !!editingDatetime;
  const datetime  = isEditing
    ? editingDatetime
    : currentDate.toISOString().slice(0, 10) + 'T' + new Date().toTimeString().slice(0, 8);

  const record = {
    datetime,
    meal:      selectedMeal,
    food_name: name,
    amount_g:  0,
    calories:  parseFloat(document.getElementById('f-cal').value)     || 0,
    sodium:    na,
    carbs:     parseFloat(document.getElementById('f-carb').value)    || 0,
    fat:       parseFloat(document.getElementById('f-fat').value)      || 0,
    sugar:     parseFloat(document.getElementById('f-sugar').value)   || 0,
    protein:   parseFloat(document.getElementById('f-protein').value) || 0,
    servings:  currentServing,
    count:     currentCount,
    notes:     document.getElementById('f-notes').value.trim(),
    synced:    false
  };

  const records = getRecords();

  if (isEditing) {
    const idx = records.findIndex(r => r.datetime === editingDatetime);
    const oldRecord = idx >= 0 ? records[idx] : null;
    if (idx >= 0) records[idx] = record; else records.push(record);
    saveRecords(records);
    closeModal();
    renderPage();
    showToast(`${name} ìˆ˜ì •ë¨`);
    if (oldRecord?.synced) {
      deleteFromSheet(oldRecord);
      const ok = await syncFood(record);
      if (ok) {
        const all = getRecords();
        const i = all.findIndex(r => r.datetime === datetime);
        if (i >= 0) { all[i].synced = true; saveRecords(all); }
      }
    }
  } else {
    records.push(record);
    saveRecords(records);
    closeModal();
    renderPage();
    showToast(`${name} ì¶”ê°€ë¨`);
    const ok = await syncFood(record);
    if (ok) {
      const all = getRecords();
      const idx = all.findIndex(r => r.datetime === datetime && r.food_name === name);
      if (idx >= 0) { all[idx].synced = true; saveRecords(all); }
    }
  }
}

// â”€â”€ ì‚­ì œ â”€â”€
function deleteFood(datetime, foodName) {
  if (!confirm(`'${foodName}' ê¸°ë¡ì„ ì‚­ì œí• ê¹Œìš”?`)) return;
  const records = getRecords().filter(r => !(r.datetime === datetime && r.food_name === foodName));
  saveRecords(records);
  renderPage();
  showToast('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
  const url = localStorage.getItem(API_KEY);
  if (url) deleteFromSheet({ datetime, food_name: foodName });
}

// â”€â”€ ë Œë”ë§ â”€â”€
function renderPage() {
  document.getElementById('date-display').textContent = displayDate(currentDate);
  const records = getTodayRecords();

  // ì˜ì–‘ í•©ê³„
  const totals = records.reduce((acc, r) => {
    acc.na    += r.sodium   || 0;
    acc.cal   += r.calories || 0;
    acc.sugar += r.sugar    || 0;
    acc.fat   += r.fat      || 0;
    return acc;
  }, { na: 0, cal: 0, sugar: 0, fat: 0 });

  document.getElementById('total-na').textContent    = Math.round(totals.na).toLocaleString();
  document.getElementById('total-cal').textContent   = Math.round(totals.cal);
  document.getElementById('total-sugar').textContent = Math.round(totals.sugar) + 'g';
  document.getElementById('total-fat').textContent   = Math.round(totals.fat) + 'g';

  const pct = Math.min((totals.na / 2000) * 100, 100);
  const bar = document.getElementById('na-progress');
  bar.style.width = pct + '%';
  bar.className = 'progress-fill' + (pct >= 100 ? ' danger' : pct >= 70 ? ' warn' : '');
  document.getElementById('na-percent').textContent = Math.round(pct) + '%';

  // ì‹ì‚¬ë³„ ë Œë”ë§
  const container = document.getElementById('meals-container');
  container.innerHTML = MEALS.map(meal => {
    const items = records.filter(r => r.meal === meal);
    const mealNa = items.reduce((s, r) => s + (r.sodium || 0), 0);
    return `
      <div class="meal-section">
        <div class="meal-header">
          <div class="meal-title">
            ${MEAL_EMOJI[meal]} ${meal}
            ${mealNa > 0 ? `<span style="font-size:0.75rem; color:var(--red); font-weight:400">Na ${Math.round(mealNa)}mg</span>` : ''}
          </div>
          <button class="add-btn" onclick="openModal('${meal}')">+ ì¶”ê°€</button>
        </div>
        ${items.length === 0
          ? `<div class="empty-meal">ê¸°ë¡ ì—†ìŒ</div>`
          : items.map(r => {
              const cntText = (r.count && r.count > 1) ? `${r.count}ê°œ` : '';
              const srvText = fmtServing(r.servings);
              const quantText = (cntText && srvText) ? `${cntText} Ã— ${srvText}`
                              : (cntText || srvText);
              const subParts = [quantText, r.notes].filter(Boolean);
              return `
            <div class="food-item">
              <div>
                <div class="food-name">${r.food_name}</div>
                <div class="food-sub">${subParts.join(' Â· ')}</div>
              </div>
              <div class="food-right">
                <div class="food-na">Na ${Math.round(r.sodium)}mg</div>
                <div class="food-cal">${Math.round(r.calories)}kcal</div>
              </div>
              <div class="food-actions">
                <button class="food-edit" onclick="openEditModal('${r.datetime}')">âœ</button>
                <button class="food-del" onclick="deleteFood('${r.datetime}','${r.food_name.replace(/'/g,"\\'")}')">âœ•</button>
              </div>
            </div>`;
            }).join('')}
      </div>`;
  }).join('');
}

// â”€â”€ í† ìŠ¤íŠ¸ â”€â”€
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg; t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2200);
}

// â”€â”€ ì´ˆê¸°í™” â”€â”€
document.addEventListener('DOMContentLoaded', () => {
  renderPage();
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./sw.js').catch(() => {});
  }
});
</script>
</body>
</html>
